!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports.webrtmp=t():e.webrtmp=t()}(self,(()=>(()=>{"use strict";var e={m:{},d:(t,s)=>{for(var i in s)e.o(s,i)&&!e.o(t,i)&&Object.defineProperty(t,i,{enumerable:!0,get:s[i]})},u:e=>"dist/webrtmp.worker.js",o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t),r:e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},p:"/webrtmp/"};e.b=document.baseURI||self.location.href;var t={};e.r(t),e.d(t,{default:()=>g});class s{static OFF=-1;static TRACE=0;static DEBUG=1;static INFO=2;static WARN=3;static ERROR=4;static CRITICAL=5;static WITH_STACKTRACE=!0;static LEVEL=s.INFO;static loglevels={};static _output=function(e,t,...i){let n=s.LEVEL;if(s.loglevels[t]&&(n=s.loglevels[t]),n===s.OFF)return;if(n>e)return;const r=s._getStackTrace();r.shift(),r.shift();let o="color: silver";switch(e){case s.TRACE:o="background-color: gray";break;case s.DEBUG:break;case s.INFO:o="color: green";break;case s.WARN:o="color: orange; background-color: #EAA80035";break;case s.ERROR:o="color: red; background-color: #FF000020";break;case s.CRITICAL:o="color: red"}s._print(r,o,t,...i)};static _print(e,t,i,...n){if(s.WITH_STACKTRACE){s.LEVEL===s.ERROR?console.group("%c["+i+"]",t,...n):console.groupCollapsed("%c["+i+"]",t,...n);for(let s=0;s<e.length;s++)console.log("%c"+e[s],t);console.groupEnd()}else console.log("%c["+i+"]",t,...n)}static _getStackTrace=function(){let e=[];try{i.dont.exist+=0}catch(t){if(t.stack){let s=t.stack.split("\n");for(let t=0;t<s.length;t++)e.push(s[t]);e.shift(),e.shift()}}return e};static c(e,...t){s._output(s.CRITICAL,e,...t)}static e(e,...t){s._output(s.ERROR,e,...t)}static i(e,...t){s._output(s.INFO,e,...t)}static w(e,...t){s._output(s.WARN,e,...t)}static d(e,...t){s._output(s.DEBUG,e,...t)}static v(e,...t){s._output(s.DEBUG,e,...t)}static t(e,...t){s._output(s.TRACE,e,...t)}}const n=s,r=class{ListenerList=[];TAG="EventEmitter";constructor(){}addEventListener(e,t){this.ListenerList.push([e,t])}addListener(e,t){this.ListenerList.push([e,t])}removeListener(e,t){for(let s=0;s<this.ListenerList.length;s++){let i=this.ListenerList[s];if(i[0]==e&&i[1]==t)return void this.ListenerList.splice(s,1)}}removeAllListeners(){this.ListenerList=[]}emit(e,...t){n.t(this.TAG,"emit EVENT: "+e,...t);for(let s=0;s<this.ListenerList.length;s++){let i=this.ListenerList[s];i[0]===e&&i[1].call(this,...t)}}};class o{constructor(){this._list=[]}clear(){this._list=[]}appendArray(e){let t=this._list;0!==e.length&&(t.length>0&&e[0].originalDts<t[t.length-1].originalDts&&this.clear(),Array.prototype.push.apply(t,e))}getLastSyncPointBeforeDts(e){if(0===this._list.length)return null;let t=this._list,s=0,i=t.length-1,n=0,r=0,o=i;for(e<t[0].dts&&(s=0,r=o+1);r<=o;){if(n=r+Math.floor((o-r)/2),n===i||e>=t[n].dts&&e<t[n+1].dts){s=n;break}t[n].dts<e?r=n+1:o=n-1}return this._list[s]}}class a{constructor(e){this._message=e}get name(){return"RuntimeException"}get message(){return this._message}toString(){return this.name+": "+this.message}}class d extends a{constructor(e){super(e)}get name(){return"IllegalStateException"}}const h={enableStashBuffer:!0,stashInitialSize:void 0,isLive:!0,autoCleanupSourceBuffer:!0,autoCleanupMaxBackwardDuration:180,autoCleanupMinBackwardDuration:120,statisticsInfoReportInterval:600,fixAudioTimestampGap:!0,headers:void 0},u="init_segment",c="media_segment",l="error",m="buffer_full";let p={};!function(){let e=self.navigator.userAgent.toLowerCase(),t=/(edge)\/([\w.]+)/.exec(e)||/(opr)[\/]([\w.]+)/.exec(e)||/(chrome)[ \/]([\w.]+)/.exec(e)||/(iemobile)[\/]([\w.]+)/.exec(e)||/(version)(applewebkit)[ \/]([\w.]+).*(safari)[ \/]([\w.]+)/.exec(e)||/(webkit)[ \/]([\w.]+).*(version)[ \/]([\w.]+).*(safari)[ \/]([\w.]+)/.exec(e)||/(webkit)[ \/]([\w.]+)/.exec(e)||/(opera)(?:.*version|)[ \/]([\w.]+)/.exec(e)||/(msie) ([\w.]+)/.exec(e)||e.indexOf("trident")>=0&&/(rv)(?::| )([\w.]+)/.exec(e)||e.indexOf("compatible")<0&&/(firefox)[ \/]([\w.]+)/.exec(e)||[],s=/(ipad)/.exec(e)||/(ipod)/.exec(e)||/(windows phone)/.exec(e)||/(iphone)/.exec(e)||/(kindle)/.exec(e)||/(android)/.exec(e)||/(windows)/.exec(e)||/(mac)/.exec(e)||/(linux)/.exec(e)||/(cros)/.exec(e)||[],i={browser:t[5]||t[3]||t[1]||"",version:t[2]||t[4]||"0",majorVersion:t[4]||t[2]||"0",platform:s[0]||""},n={};if(i.browser){n[i.browser]=!0;let e=i.majorVersion.split(".");n.version={major:parseInt(i.majorVersion,10),string:i.version},e.length>1&&(n.version.minor=parseInt(e[1],10)),e.length>2&&(n.version.build=parseInt(e[2],10))}if(i.platform&&(n[i.platform]=!0),(n.chrome||n.opr||n.safari)&&(n.webkit=!0),n.rv||n.iemobile){n.rv&&delete n.rv;let e="msie";i.browser=e,n[e]=!0}if(n.edge){delete n.edge;let e="msedge";i.browser=e,n[e]=!0}if(n.opr){let e="opera";i.browser=e,n[e]=!0}if(n.safari&&n.android){let e="android";i.browser=e,n[e]=!0}n.name=i.browser,n.platform=i.platform;for(let e in p)p.hasOwnProperty(e)&&delete p[e];Object.assign(p,n)}();const f=p;class _{TAG="WebRTMP";_mediaElement=null;constructor(){this.wss=new class{TAG="WebRTMP_Controller";host=document.location.host;port=9001;WSSReconnect=!1;isConnected=!1;loglevels={RTMPMessage:n.ERROR,RTMPMessageHandler:n.WARN,RTMPMediaMessageHandler:n.ERROR,ChunkParser:n.WARN,RTMPHandshake:n.ERROR,Chunk:n.OFF,MP4Remuxer:n.ERROR,Transmuxer:n.WARN,EventEmitter:n.DEBUG,MSEController:n.INFO,WebRTMP:n.WARN,WebRTMP_Controller:n.WARN,"WebRTMP Worker":n.WARN,AMF:n.WARN};WebRTMPWorker=new Worker(new URL(e.p+e.u(306),e.b),{name:"webrtmp.worker",type:void 0});constructor(){n.loglevels=this.loglevels,this._emitter=new r,this.WebRTMPWorker.addEventListener("message",(e=>{this.WorkerListener(e)}))}open(e,t){if(this.isConnected)return!1;e&&(this.host=e),t&&(this.port=t),this.WebRTMPWorker.postMessage({cmd:"open",host:this.host,port:this.port})}disconnect(){this.WSSReconnect=!0,this.WebRTMPWorker.postMessage({cmd:"disconnect"})}connect(e){this.WebRTMPWorker.postMessage({cmd:"connect",appName:e})}play(e){this.WebRTMPWorker.postMessage({cmd:"play",streamName:e})}stop(){this.WebRTMPWorker.postMessage({cmd:"stop"})}pause(e){this.WebRTMPWorker.postMessage({cmd:"pause",enable:e})}addEventListener(e,t){this._emitter.addEventListener(e,t)}removeEventListener(e,t){this._emitter.removeListener(e,t)}WorkerListener(e){const t=e.data;switch(t[0]){case"ConnectionLost":this._emitter.emit("ConnectionLost"),n.d(this.TAG,"Event ConnectionLost"),this.isConnected=!1,this.WSSReconnect&&(n.w(this.TAG,"[ WorkerListener ] Reconnect timed"),window.setTimeout((()=>{n.w(this.TAG,"timed Reconnect"),this.open(this.host,this.port)}),1e3));break;case"Connected":n.d(this.TAG,"Event Connected"),this._emitter.emit("Connected"),this.isConnected=!0;break;case"Started":this.WebRTMPWorker.postMessage({cmd:"loglevels",loglevels:this.loglevels});break;default:n.i(this.TAG,t[0],t.slice(1)),this._emitter.emit(t[0],t.slice(1))}}},this._config=h,this.wss.addEventListener("RTMPMessageArrived",(e=>{n.d(this.TAG,"RTMPMessageArrived",e)})),this.wss.addEventListener("ProtocolControlMessage",(e=>{n.d(this.TAG,"ProtocolControlMessage",e)})),this.wss.addEventListener("UserControlMessage",(e=>{n.d(this.TAG,"UserControlMessage",e)})),this.wss.addEventListener("ConnectionLost",(()=>{})),this._emitter=new r,this.e={onvLoadedMetadata:this._onvLoadedMetadata.bind(this),onvCanPlay:this._onvCanPlay.bind(this),onvStalled:this._onvStalled.bind(this),onvProgress:this._onvProgress.bind(this)}}_checkAndResumeStuckPlayback(e){let t=this._mediaElement;if(e||!this._receivedCanPlay||t.readyState<2){let e=t.buffered;e.length>0&&t.currentTime<e.start(0)&&(n.w(this.TAG,`Playback seems stuck at ${t.currentTime}, seek to ${e.start(0)}`),this._requestSetTime=!0,this._mediaElement.currentTime=e.start(0),this._mediaElement.removeEventListener("progress",this.e.onvProgress))}else this._mediaElement.removeEventListener("progress",this.e.onvProgress)}_onvLoadedMetadata(e){null!=this._pendingSeekTime&&(this._mediaElement.currentTime=this._pendingSeekTime,this._pendingSeekTime=null)}_onvCanPlay(e){this._mediaElement.play(),this._receivedCanPlay=!0,this._mediaElement.removeEventListener("canplay",this.e.onvCanPlay)}_onvStalled(e){this._checkAndResumeStuckPlayback(!0)}_onvProgress(e){this._checkAndResumeStuckPlayback()}_onmseBufferFull(){n.w(this.TAG,"MSE SourceBuffer is full")}destroy(){this._mediaElement&&this.detachMediaElement(),this.e=null,this._emitter.removeAllListeners(),this._emitter=null}disconnect(){this.wss.disconnect()}play(e){return new Promise(((t,s)=>{this.wss.play(e),this._mediaElement.play().then(t)}))}stop(){this.wss.stop(),this._mediaElement.pause()}open(e,t){return new Promise(((s,i)=>{this.wss.addEventListener("RTMPHandshakeDone",(e=>{n.d(this.TAG,"RTMPHandshakeDone"),e?s():i()})),this.wss.addEventListener("WSSConnectFailed",(()=>{n.d(this.TAG,"WSSConnectFailed"),i()})),this.wss.open(e,t)}))}connect(e){return new Promise(((t,s)=>{this.wss.addEventListener("RTMPStreamCreated",((e,s)=>{n.d(this.TAG,"RTMPStreamCreated: "+s),t()})),this.wss.connect(e)}))}pause(e){this.wss.pause(e)}detachMediaElement(){this._mediaElement&&(this._msectl.detachMediaElement(),this._mediaElement.removeEventListener("loadedmetadata",this.e.onvLoadedMetadata),this._mediaElement.removeEventListener("canplay",this.e.onvCanPlay),this._mediaElement.removeEventListener("stalled",this.e.onvStalled),this._mediaElement.removeEventListener("progress",this.e.onvProgress),this._mediaElement=null),this._msectl&&(this.wss.removeEventListener(u,this._appendInitSegment),this.wss.removeEventListener(c,this._appendMediaSegment),this._msectl.destroy(),this._msectl=null)}attachMediaElement(e){this._mediaElement=e,e.addEventListener("loadedmetadata",this.e.onvLoadedMetadata),e.addEventListener("canplay",this.e.onvCanPlay),e.addEventListener("stalled",this.e.onvStalled),e.addEventListener("progress",this.e.onvProgress),this._msectl=new class{TAG="MSEController";constructor(e){this._config=e,this._emitter=new r,this._config.isLive&&null==this._config.autoCleanupSourceBuffer&&(this._config.autoCleanupSourceBuffer=!0),this.e={onSourceOpen:this._onSourceOpen.bind(this),onSourceEnded:this._onSourceEnded.bind(this),onSourceClose:this._onSourceClose.bind(this),onSourceBufferError:this._onSourceBufferError.bind(this),onSourceBufferUpdateEnd:this._onSourceBufferUpdateEnd.bind(this)},this._mediaSource=null,this._mediaSourceObjectURL=null,this._mediaElement=null,this._isBufferFull=!1,this._hasPendingEos=!1,this._requireSetMediaDuration=!1,this._pendingMediaDuration=0,this._pendingSourceBufferInit=[],this._mimeTypes={video:null,audio:null},this._sourceBuffers={video:null,audio:null},this._lastInitSegments={video:null,audio:null},this._pendingSegments={video:[],audio:[]},this._pendingRemoveRanges={video:[],audio:[]},this._idrList=new o}destroy(){(this._mediaElement||this._mediaSource)&&this.detachMediaElement(),this.e=null,this._emitter.removeAllListeners(),this._emitter=null}on(e,t){this._emitter.addListener(e,t)}off(e,t){this._emitter.removeListener(e,t)}attachMediaElement(e){if(this._mediaSource)throw new d("MediaSource has been attached to an HTMLMediaElement!");let t=this._mediaSource=new window.MediaSource;t.addEventListener("sourceopen",this.e.onSourceOpen),t.addEventListener("sourceended",this.e.onSourceEnded),t.addEventListener("sourceclose",this.e.onSourceClose),this._mediaElement=e,this._mediaSourceObjectURL=window.URL.createObjectURL(this._mediaSource),e.src=this._mediaSourceObjectURL}detachMediaElement(){if(this._mediaSource){let e=this._mediaSource;for(let t in this._sourceBuffers){let s=this._pendingSegments[t];s.splice(0,s.length),this._pendingSegments[t]=null,this._pendingRemoveRanges[t]=null,this._lastInitSegments[t]=null;let i=this._sourceBuffers[t];if(i){if("closed"!==e.readyState){try{e.removeSourceBuffer(i)}catch(e){n.e(this.TAG,e.message)}i.removeEventListener("error",this.e.onSourceBufferError),i.removeEventListener("updateend",this.e.onSourceBufferUpdateEnd)}this._mimeTypes[t]=null,this._sourceBuffers[t]=null}}if("open"===e.readyState)try{e.endOfStream()}catch(e){n.e(this.TAG,e.message)}e.removeEventListener("sourceopen",this.e.onSourceOpen),e.removeEventListener("sourceended",this.e.onSourceEnded),e.removeEventListener("sourceclose",this.e.onSourceClose),this._pendingSourceBufferInit=[],this._isBufferFull=!1,this._idrList.clear(),this._mediaSource=null}this._mediaElement&&(this._mediaElement.src="",this._mediaElement.removeAttribute("src"),this._mediaElement=null),this._mediaSourceObjectURL&&(window.URL.revokeObjectURL(this._mediaSourceObjectURL),this._mediaSourceObjectURL=null)}appendInitSegment(e,t){if(n.i(this.TAG,"appendInitSegment",e),!this._mediaSource||"open"!==this._mediaSource.readyState)return this._pendingSourceBufferInit.push(e),void this._pendingSegments[e.type].push(e);let s=e,i=`${s.container}`;s.codec&&s.codec.length>0&&(i+=`;codecs=${s.codec}`);let r=!1;if(n.v(this.TAG,"Received Initialization Segment, mimeType: "+i),this._lastInitSegments[s.type]=s,i!==this._mimeTypes[s.type]){if(this._mimeTypes[s.type])n.v(this.TAG,`Notice: ${s.type} mimeType changed, origin: ${this._mimeTypes[s.type]}, target: ${i}`);else{r=!0;try{let e=this._sourceBuffers[s.type]=this._mediaSource.addSourceBuffer(i);e.addEventListener("error",this.e.onSourceBufferError),e.addEventListener("updateend",this.e.onSourceBufferUpdateEnd)}catch(e){return n.e(this.TAG,e.message),void this._emitter.emit(l,{code:e.code,msg:e.message})}}this._mimeTypes[s.type]=i}t||this._pendingSegments[s.type].push(s),r||this._sourceBuffers[s.type]&&!this._sourceBuffers[s.type].updating&&this._doAppendSegments(),f.safari&&"audio/mpeg"===s.container&&s.mediaDuration>0&&(this._requireSetMediaDuration=!0,this._pendingMediaDuration=s.mediaDuration/1e3,this._updateMediaSourceDuration())}appendMediaSegment(e){n.d(this.TAG,"appendMediaSegment",e);let t=e;this._pendingSegments[t.type].push(t),this._config.autoCleanupSourceBuffer&&this._needCleanupSourceBuffer()&&this._doCleanupSourceBuffer();let s=this._sourceBuffers[t.type];!s||s.updating||this._hasPendingRemoveRanges()||this._doAppendSegments()}seek(e){for(let e in this._sourceBuffers){if(!this._sourceBuffers[e])continue;let t=this._sourceBuffers[e];if("open"===this._mediaSource.readyState)try{t.abort()}catch(e){n.e(this.TAG,e.message)}this._idrList.clear();let s=this._pendingSegments[e];if(s.splice(0,s.length),"closed"!==this._mediaSource.readyState){for(let s=0;s<t.buffered.length;s++){let i=t.buffered.start(s),n=t.buffered.end(s);this._pendingRemoveRanges[e].push({start:i,end:n})}if(t.updating||this._doRemoveRanges(),f.safari){let s=this._lastInitSegments[e];s&&(this._pendingSegments[e].push(s),t.updating||this._doAppendSegments())}}}}endOfStream(){let e=this._mediaSource,t=this._sourceBuffers;e&&"open"===e.readyState?t.video&&t.video.updating||t.audio&&t.audio.updating?this._hasPendingEos=!0:(this._hasPendingEos=!1,e.endOfStream()):e&&"closed"===e.readyState&&this._hasPendingSegments()&&(this._hasPendingEos=!0)}getNearestKeyframe(e){return this._idrList.getLastSyncPointBeforeDts(e)}_needCleanupSourceBuffer(){if(!this._config.autoCleanupSourceBuffer)return!1;let e=this._mediaElement.currentTime;for(let t in this._sourceBuffers){let s=this._sourceBuffers[t];if(s){let t=s.buffered;if(t.length>=1&&e-t.start(0)>=this._config.autoCleanupMaxBackwardDuration)return!0}}return!1}_doCleanupSourceBuffer(){let e=this._mediaElement.currentTime;for(let t in this._sourceBuffers){let s=this._sourceBuffers[t];if(s){let i=s.buffered,n=!1;for(let s=0;s<i.length;s++){let r=i.start(s),o=i.end(s);if(r<=e&&e<o+3){if(e-r>=this._config.autoCleanupMaxBackwardDuration){n=!0;let s=e-this._config.autoCleanupMinBackwardDuration;this._pendingRemoveRanges[t].push({start:r,end:s})}}else o<e&&(n=!0,this._pendingRemoveRanges[t].push({start:r,end:o}))}n&&!s.updating&&this._doRemoveRanges()}}}_updateMediaSourceDuration(){let e=this._sourceBuffers;if(0===this._mediaElement.readyState||"open"!==this._mediaSource.readyState)return;if(e.video&&e.video.updating||e.audio&&e.audio.updating)return;let t=this._mediaSource.duration,s=this._pendingMediaDuration;s>0&&(isNaN(t)||s>t)&&(n.v(this.TAG,`Update MediaSource duration from ${t} to ${s}`),this._mediaSource.duration=s),this._requireSetMediaDuration=!1,this._pendingMediaDuration=0}_doRemoveRanges(){for(let e in this._pendingRemoveRanges){if(!this._sourceBuffers[e]||this._sourceBuffers[e].updating)continue;let t=this._sourceBuffers[e],s=this._pendingRemoveRanges[e];for(;s.length&&!t.updating;){let e=s.shift();t.remove(e.start,e.end)}}}_doAppendSegments(){let e=this._pendingSegments;for(let t in e)if(this._sourceBuffers[t]&&!this._sourceBuffers[t].updating&&e[t].length>0){let s=e[t].shift();if(s.timestampOffset){let e=this._sourceBuffers[t].timestampOffset,i=s.timestampOffset/1e3;Math.abs(e-i)>.1&&(n.v(this.TAG,`Update MPEG audio timestampOffset from ${e} to ${i}`),this._sourceBuffers[t].timestampOffset=i),delete s.timestampOffset}if(!s.data||0===s.data.byteLength)continue;try{this._sourceBuffers[t].appendBuffer(s.data),this._isBufferFull=!1,"video"===t&&s.hasOwnProperty("info")&&this._idrList.appendArray(s.info.syncPoints)}catch(e){this._pendingSegments[t].unshift(s),22===e.code?(this._isBufferFull||this._emitter.emit(m),this._isBufferFull=!0):(n.e(this.TAG,e.message),this._emitter.emit(l,{code:e.code,msg:e.message}))}}}_onSourceOpen(){if(n.v(this.TAG,"MediaSource onSourceOpen"),this._mediaSource.removeEventListener("sourceopen",this.e.onSourceOpen),this._pendingSourceBufferInit.length>0){let e=this._pendingSourceBufferInit;for(;e.length;){let t=e.shift();this.appendInitSegment(t,!0)}}this._hasPendingSegments()&&this._doAppendSegments(),this._emitter.emit("source_open")}_onSourceEnded(){n.v(this.TAG,"MediaSource onSourceEnded")}_onSourceClose(){n.v(this.TAG,"MediaSource onSourceClose"),this._mediaSource&&null!=this.e&&(this._mediaSource.removeEventListener("sourceopen",this.e.onSourceOpen),this._mediaSource.removeEventListener("sourceended",this.e.onSourceEnded),this._mediaSource.removeEventListener("sourceclose",this.e.onSourceClose))}_hasPendingSegments(){let e=this._pendingSegments;return e.video.length>0||e.audio.length>0}_hasPendingRemoveRanges(){let e=this._pendingRemoveRanges;return e.video.length>0||e.audio.length>0}_onSourceBufferUpdateEnd(){this._requireSetMediaDuration?this._updateMediaSourceDuration():this._hasPendingRemoveRanges()?this._doRemoveRanges():this._hasPendingSegments()?this._doAppendSegments():this._hasPendingEos&&this.endOfStream(),this._emitter.emit("update_end")}_onSourceBufferError(e){n.e(this.TAG,`SourceBuffer Error: ${e}`)}}(h),this._msectl.on(m,this._onmseBufferFull.bind(this)),this._msectl.on(l,(e=>{this._emitter.emit("error","MediaError","MediaMSEError",e)})),this.wss.addEventListener(u,this._appendInitSegment.bind(this)),this.wss.addEventListener(c,this._appendMediaSegment.bind(this)),this._msectl.attachMediaElement(e)}_appendInitSegment(e){n.i(this.TAG,u,e[0],e[1]),this._msectl.appendInitSegment(e[1])}_appendMediaSegment(e){n.i(this.TAG,c,e[0],e[1]),this._msectl.appendMediaSegment(e[1])}}const g=_;return window.Log=n,window.webrtmp=new _,t})()));
//# sourceMappingURL=webrtmp.min.js.map