(()=>{"use strict";class e{static OFF=-1;static TRACE=0;static DEBUG=1;static INFO=2;static WARN=3;static ERROR=4;static CRITICAL=5;static WITH_STACKTRACE=!0;static LEVEL=e.INFO;static loglevels={};static _output=function(t,s,...i){let a=e.LEVEL;if(e.loglevels[s]&&(a=e.loglevels[s]),a===e.OFF)return;if(a>t)return;const n=e._getStackTrace();n.shift(),n.shift();let r="color: silver";switch(t){case e.TRACE:r="background-color: gray";break;case e.DEBUG:break;case e.INFO:r="color: green";break;case e.WARN:r="color: orange; background-color: #EAA80035";break;case e.ERROR:r="color: red; background-color: #FF000020";break;case e.CRITICAL:r="color: red"}e._print(n,r,s,...i)};static _print(t,s,i,...a){if(e.WITH_STACKTRACE){e.LEVEL===e.ERROR?console.group("%c["+i+"]",s,...a):console.groupCollapsed("%c["+i+"]",s,...a);for(let e=0;e<t.length;e++)console.log("%c"+t[e],s);console.groupEnd()}else console.log("%c["+i+"]",s,...a)}static _getStackTrace=function(){let e=[];try{i.dont.exist+=0}catch(t){if(t.stack){let s=t.stack.split("\n");for(let t=0;t<s.length;t++)e.push(s[t]);e.shift(),e.shift()}}return e};static c(t,...s){e._output(e.CRITICAL,t,...s)}static e(t,...s){e._output(e.ERROR,t,...s)}static i(t,...s){e._output(e.INFO,t,...s)}static w(t,...s){e._output(e.WARN,t,...s)}static d(t,...s){e._output(e.DEBUG,t,...s)}static v(t,...s){e._output(e.DEBUG,t,...s)}static t(t,...s){e._output(e.TRACE,t,...s)}}const t=e;function s(...e){const t=new Uint8Array(e.reduce(((e,t)=>e+t.byteLength),0));return e.reduce(((e,s)=>(t.set(s,e),e+s.byteLength)),0),t}function a(e){const t=[];for(let s=0;s<e.length;s++){const i=e.charCodeAt(s);i>255&&t.push(i>>>8),t.push(255&i)}return t}function n(e){const t=new ArrayBuffer(8);return new DataView(t).setFloat64(0,e,!1),[].slice.call(new Uint8Array(t))}function r(e){let t=new ArrayBuffer(e.length),s=new DataView(t);return e.forEach((function(e,t){s.setUint8(t,e)})),s.getFloat64(0)}function o(e){let t="";for(let s=0;s<e.length;s++)t+=String.fromCharCode(e[s]);return t}const h={enableWorker:!1,enableStashBuffer:!0,stashInitialSize:void 0,isLive:!0,lazyLoad:!0,lazyLoadMaxDuration:180,lazyLoadRecoverDuration:30,deferLoadAfterSourceOpen:!0,autoCleanupSourceBuffer:!0,autoCleanupMaxBackwardDuration:180,autoCleanupMinBackwardDuration:120,statisticsInfoReportInterval:600,fixAudioTimestampGap:!0,accurateSeek:!1,seekType:"range",seekParamStart:"bstart",seekParamEnd:"bend",rangeLoadZeroStart:!1,customSeekHandler:void 0,reuseRedirectedURL:!1,headers:void 0,customLoader:void 0},d="init_segment",l="media_segment",c="media_info",u="metadata_arrived",m="scriptdata_arrived",g="FormatError",p="CodecUnsupported",_=class{TAG="RTMPMessage";static MessageTypes=["dummy","PCMSetChunkSize","PCMAbortMessage","PCMAcknolegement","UserControlMessage","WindowAcknowledgementSize","PCMSetPeerBandwidth","dummy","AudioMessage","VideoMessage","dummy","dummy","dummy","dummy","dummy","DataMessageAMF3","Shared Object Message AMF3","CommandMessageAMF3","DataMessageAMF0","SharedObjectMessageAMF0","CommandMessageAMF0","dummy","Aggregate Message"];messageType;messageLength=0;length=0;timestamp=0;extendedTimestamp=!1;message_stream_id=0;payload=new Uint8Array(0);constructor(e){e&&(this.setMessageLength(e.length),this.addPayload(e))}clearPayload(){this.payload=new Uint8Array(0)}getBytes(){return this.header=new Uint8Array(11),this.header[0]=this.messageType,this.header[1]=this.length>>>16,this.header[2]=this.length>>>8,this.header[3]=this.length,this.header[4]=this.timestamp>>>24,this.header[5]=this.timestamp>>>16,this.header[6]=this.timestamp>>>8,this.header[7]=this.timestamp,this.header[8]=this.message_stream_id>>>16,this.header[9]=this.message_stream_id>>>8,this.header[10]=this.message_stream_id,s(this.header,this.payload)}setMessageType(e){switch(this.messageType=e,e){case 1:case 2:case 3:case 4:case 5:case 6:this.message_stream_id=0}}getMessageType(){return this.messageType}getMessageStreamID(){return this.message_stream_id}setMessageStreamID(e){this.message_stream_id=e}getPayloadlength(){return this.payload.length}getTimestamp(){return this.timestamp}setMessageTimestamp(e){t.v(this.TAG,"TS: "+e),this.timestamp=e}setExtendedTimestamp(e){t.w(this.TAG,"setExtendedTimestamp"),this.extendedTimestamp=e}getExtendedTimestamp(){return this.extendedTimestamp}setTimestampDelta(e){t.v(this.TAG,"TS: "+this.timestamp+" Delta: "+e),this.timestamp+=e}addPayload(e){e.length>this.bytesMissing()?t.e(this.TAG,"try to add too much data"):(this.payload=s(this.payload,e),this.length=this.payload.length,t.d(this.TAG,"[ RTMPMessage ] payload size is now: "+this.length))}getPayload(){return this.payload}setMessageLength(e){this.messageLength=e}getMessageLength(){return this.messageLength}isComplete(){return this.payload.length===this.messageLength}bytesMissing(){return this.messageLength-this.payload.length}},f=class{TAG="Chunk";chunk_stream_id=0;length;message_type;message_stream_id=0;timestamp;CHUNK_SIZE=128;payload;constructor(e){this.payload=e.getPayload(),this.length=this.payload.length,this.message_type=e.getMessageType(),this.message_stream_id=e.getMessageStreamID()}getBytes(){let e=new Uint8Array(this.payload),i=new Uint8Array(0),a=0;do{t.d(this.TAG,"create chunk: "+e.length),i=s(i,this._getHeaderBytes(a),e.slice(0,this.CHUNK_SIZE)),e=e.slice(this.CHUNK_SIZE),a=3}while(e.length>0);return i}_getHeaderBytes(e){let t,i;switch(this.chunk_stream_id<63?(t=new Uint8Array(1),t[0]=e<<6|this.chunk_stream_id):this.chunk_stream_id<65599?(t=new Uint8Array(2),t[0]=e<<6,t[1]=this.chunk_stream_id-64):(t=new Uint8Array(3),t[0]=e<<6|63,t[1]=this.chunk_stream_id-64>>>8,t[2]=this.chunk_stream_id-64),e){case 0:i=new Uint8Array(11),i[0]=this.timestamp>>>16,i[1]=this.timestamp>>>8,i[2]=this.timestamp,i[3]=this.length>>>16,i[4]=this.length>>>8,i[5]=this.length,i[6]=this.message_type,i[7]=this.message_stream_id>>>24,i[8]=this.message_stream_id>>>16,i[9]=this.message_stream_id>>>8,i[10]=this.message_stream_id;break;case 1:i=new Uint8Array(7),i[0]=this.timestamp>>>16,i[1]=this.timestamp>>>8,i[2]=this.timestamp,i[3]=this.length>>>16,i[4]=this.length>>>8,i[5]=this.length,i[6]=this.message_type;break;case 2:i=new Uint8Array(3),i[0]=this.timestamp>>>16,i[1]=this.timestamp>>>8,i[2]=this.timestamp;break;case 3:i=new Uint8Array(0)}return s(t,i)}getPayload(){return this.payload}getMessageType(){return this.message_type}getMessageStreamID(){return this.message_stream_id}setChunkSize(e){this.CHUNK_SIZE=e}setChunkStreamID(e){t.d(this.TAG,"setChunkStreamID:"+e),this.chunk_stream_id=e}setMessageStreamID(e){this.message_stream_id=e}setTimestamp(e){this.timestamp=e}};class A{event_type;event_data1;event_data2;static events=["StreamBegin","StreamEOF","StreamDry","SetBuffer","StreamIsRecorded","dummy","PingRequest","PingResponse"];getBytes(){let e;return this.event_data2?(e=new Uint8Array(10),e[0]=this.event_type>>>8,e[1]=this.event_type,e[2]=this.event_data1>>>24,e[3]=this.event_data1>>>16,e[4]=this.event_data1>>>8,e[5]=this.event_data1,e[6]=this.event_data2>>>24,e[7]=this.event_data2>>>16,e[8]=this.event_data2>>>8,e[9]=this.event_data2):(e=new Uint8Array(6),e[0]=this.event_type>>>8,e[1]=this.event_type,e[2]=this.event_data1>>>24,e[3]=this.event_data1>>>16,e[4]=this.event_data1>>>8,e[5]=this.event_data1),e}getEventMessage(){let e={};return 3===this.event_type?e[A.events[this.event_type]]=[this.event_data1,this.event_data2]:e[A.events[this.event_type]]=this.event_data1,e}setType(e){this.event_type=e}setEventData(e){this.event_data1=e}}const y=A;class v{TAG="ProtocolControlMessage";pcm_type;data;static pcm_types=["dummy","SetChunkSize","AbortMessage","Acknowledgement","UserControlMessage","WindowAcknowledgementSize","SetPeerBandwidth"];constructor(e,s){switch(e){case 1:case 2:case 3:case 5:this.pcm_type=e,this.data=s[0]<<24|s[1]<<16|s[2]<<8|s[3];break;case 6:t.w(this.TAG,"Protocol Control Message Type: "+e+" use SetPeerBandwidthMessage");break;default:t.e(this.TAG,"Protocol Control Message Type: "+e+" not supported")}}setPayload(e){this.data=e}getEventMessage(){let e={};return e[v.pcm_types[this.pcm_type]]=this.data,e}getBytes(){let e=[];return e[0]=this.data>>>24,e[1]=this.data>>>16,e[2]=this.data>>>8,e[3]=this.data,new Uint8Array(e)}}const S=v;class b{constructor(e){this._message=e}get name(){return"RuntimeException"}get message(){return this._message}toString(){return this.name+": "+this.message}}class w extends b{constructor(e){super(e)}get name(){return"IllegalStateException"}}class M extends b{constructor(e){super(e)}get name(){return"InvalidArgumentException"}}const T=class{constructor(){this.mimeType=null,this.duration=null,this.hasAudio=null,this.hasVideo=null,this.audioCodec=null,this.videoCodec=null,this.audioDataRate=null,this.videoDataRate=null,this.audioSampleRate=null,this.audioChannelCount=null,this.width=null,this.height=null,this.fps=null,this.profile=null,this.level=null,this.refFrames=null,this.chromaFormat=null,this.sarNum=null,this.sarDen=null,this.metadata=null,this.segments=null,this.segmentCount=null,this.hasKeyframesIndex=null,this.keyframesIndex=null}isComplete(){let e=!1===this.hasAudio||!0===this.hasAudio&&null!=this.audioCodec&&null!=this.audioSampleRate&&null!=this.audioChannelCount,t=!1===this.hasVideo||!0===this.hasVideo&&null!=this.videoCodec&&null!=this.width&&null!=this.height&&null!=this.fps&&null!=this.profile&&null!=this.level&&null!=this.refFrames&&null!=this.chromaFormat&&null!=this.sarNum&&null!=this.sarDen;return null!=this.mimeType&&null!=this.duration&&null!=this.metadata&&null!=this.hasKeyframesIndex&&e&&t}isSeekable(){return!0===this.hasKeyframesIndex}getNearestKeyframe(e){if(null==this.keyframesIndex)return null;let t=this.keyframesIndex,s=this._search(t.times,e);return{index:s,milliseconds:t.times[s],fileposition:t.filepositions[s]}}_search(e,t){let s=0,i=e.length-1,a=0,n=0,r=i;for(t<e[0]&&(s=0,n=r+1);n<=r;){if(a=n+Math.floor((r-n)/2),a===i||t>=e[a]&&t<e[a+1]){s=a;break}e[a]<t?n=a+1:r=a-1}return s}};function k(e,t,s){let i=e;if(t+s<i.length){for(;s--;)if(128!=(192&i[++t]))return!1;return!0}return!1}function D(e){let t=[],s=e,i=0,a=e.length;for(;i<a;)if(s[i]<128)t.push(String.fromCharCode(s[i])),++i;else{if(s[i]<192);else if(s[i]<224){if(k(s,i,1)){let e=(31&s[i])<<6|63&s[i+1];if(e>=128){t.push(String.fromCharCode(65535&e)),i+=2;continue}}}else if(s[i]<240){if(k(s,i,2)){let e=(15&s[i])<<12|(63&s[i+1])<<6|63&s[i+2];if(e>=2048&&55296!=(63488&e)){t.push(String.fromCharCode(65535&e)),i+=3;continue}}}else if(s[i]<248&&k(s,i,3)){let e=(7&s[i])<<18|(63&s[i+1])<<12|(63&s[i+2])<<6|63&s[i+3];if(e>65536&&e<1114112){e-=65536,t.push(String.fromCharCode(e>>>10|55296)),t.push(String.fromCharCode(1023&e|56320)),i+=4;continue}}t.push(String.fromCharCode(65533)),++i}return t.join("")}let C=function(){let e=new ArrayBuffer(2);return new DataView(e).setInt16(0,256,!0),256===new Int16Array(e)[0]}();class I{static TAG="AMF";static parseScriptData(e){t.d(this.TAG,e);let s={};try{let i=I.parseValue(e);t.d(this.TAG,i);let a=I.parseValue(e.slice(i.size));t.d(this.TAG,a),s[i.data]=a.data}catch(e){t.w(this.TAG,e.toString())}return s}static parseObject(e){if(e.length<3)throw new w("Data not enough when parse ScriptDataObject");let t=I.parseString(e),s=I.parseValue(e.slice(t.size,e.length-t.size)),i=s.objectEnd;return{data:{name:t.data,value:s.data},size:t.size+s.size,objectEnd:i}}static parseVariable(e){return I.parseObject(e)}static parseString(e){if(e.length<2)throw new w("Data not enough when parse String");let t,s=new DataView(e.buffer).getUint16(0,!C);return t=s>0?D(new Uint8Array(e.slice(2,2+s))):"",{data:t,size:2+s}}static parseLongString(e){if(e.length()<4)throw new w("Data not enough when parse LongString");let t,s=new DataView(e.buffer).getUint32(0,!C);return t=s>0?D(new Uint8Array(e.slice(4,4+s))):"",{data:t,size:4+s}}static parseDate(e){if(e.length()<10)throw new w("Data size invalid when parse Date");let t=new DataView(e.buffer),s=t.getFloat64(0,!C);return s+=60*t.getInt16(8,!C)*1e3,{data:new Date(s),size:10}}static parseValue(e){if(e.length<1)throw new w("Data not enough when parse Value");let s,i=new DataView(e.buffer),a=1,n=i.getUint8(0),r=!1;try{switch(n){case 0:s=i.getFloat64(1,!C),a+=8;break;case 1:s=!!i.getUint8(1),a+=1;break;case 2:{let t=I.parseString(e.slice(1));s=t.data,a+=t.size;break}case 3:{s={};let t=0;for(9==(16777215&i.getUint32(e.length-4,!C))&&(t=3);a<e.length-4;){let i=I.parseObject(e.slice(a,a+e.length-t));if(i.objectEnd)break;s[i.data.name]=i.data.value,a+=i.size}a<=e.length-3&&9==(16777215&i.getUint32(a-1,!C))&&(a+=3);break}case 8:{s={},a+=4;let t=0;for(9==(16777215&i.getUint32(e.length-4,!C))&&(t=3);a<e.length-8;){let i=I.parseVariable(e.slice(a,a+e.length-t));if(i.objectEnd)break;s[i.data.name]=i.data.value,a+=i.size}a<=e.length-3&&9==(16777215&i.getUint32(a-1,!C))&&(a+=3);break}case 9:s=void 0,a=1,r=!0;break;case 10:{s=[];let t=i.getUint32(1,!C);a+=4;for(let i=0;i<t;i++){let t=I.parseValue(e.slice(a,e.length));s.push(t.data),a+=t.size}break}case 11:{let t=I.parseDate(e.slice(1));s=t.data,a+=t.size;break}case 12:{let t=I.parseString(e.slice(1));s=t.data,a+=t.size;break}default:a=e.length,t.w(this.TAG,"Unsupported AMF value type "+n)}}catch(e){t.e(this.TAG,e.toString())}return{data:s,size:a,objectEnd:r}}}const x=I;class G{static _ebsp2rbsp(e){let t=e,s=t.byteLength,i=new Uint8Array(s),a=0;for(let e=0;e<s;e++)e>=2&&3===t[e]&&0===t[e-1]&&0===t[e-2]||(i[a]=t[e],a++);return new Uint8Array(i.buffer,0,a)}static parseSPS(e){let t=G._ebsp2rbsp(e),s=new class{constructor(e){this.TAG="ExpGolomb",this._buffer=e,this._buffer_index=0,this._total_bytes=e.byteLength,this._total_bits=8*e.byteLength,this._current_word=0,this._current_word_bits_left=0}destroy(){this._buffer=null}_fillCurrentWord(){let e=this._total_bytes-this._buffer_index;if(e<=0)throw new w("ExpGolomb: _fillCurrentWord() but no bytes available");let t=Math.min(4,e),s=new Uint8Array(4);s.set(this._buffer.subarray(this._buffer_index,this._buffer_index+t)),this._current_word=new DataView(s.buffer).getUint32(0,!1),this._buffer_index+=t,this._current_word_bits_left=8*t}readBits(e){if(e>32)throw new M("ExpGolomb: readBits() bits exceeded max 32bits!");if(e<=this._current_word_bits_left){let t=this._current_word>>>32-e;return this._current_word<<=e,this._current_word_bits_left-=e,t}let t=this._current_word_bits_left?this._current_word:0;t>>>=32-this._current_word_bits_left;let s=e-this._current_word_bits_left;this._fillCurrentWord();let i=Math.min(s,this._current_word_bits_left),a=this._current_word>>>32-i;return this._current_word<<=i,this._current_word_bits_left-=i,t=t<<i|a,t}readBool(){return 1===this.readBits(1)}readByte(){return this.readBits(8)}_skipLeadingZero(){let e;for(e=0;e<this._current_word_bits_left;e++)if(0!=(this._current_word&2147483648>>>e))return this._current_word<<=e,this._current_word_bits_left-=e,e;return this._fillCurrentWord(),e+this._skipLeadingZero()}readUEG(){let e=this._skipLeadingZero();return this.readBits(e+1)-1}readSEG(){let e=this.readUEG();return 1&e?e+1>>>1:-1*(e>>>1)}}(t);s.readByte();let i=s.readByte();s.readByte();let a=s.readByte();s.readUEG();let n=G.getProfileString(i),r=G.getLevelString(a),o=1,h=420,d=8;if((100===i||110===i||122===i||244===i||44===i||83===i||86===i||118===i||128===i||138===i||144===i)&&(o=s.readUEG(),3===o&&s.readBits(1),o<=3&&(h=[0,420,422,444][o]),d=s.readUEG()+8,s.readUEG(),s.readBits(1),s.readBool())){let e=3!==o?8:12;for(let t=0;t<e;t++)s.readBool()&&(t<6?G._skipScalingList(s,16):G._skipScalingList(s,64))}s.readUEG();let l=s.readUEG();if(0===l)s.readUEG();else if(1===l){s.readBits(1),s.readSEG(),s.readSEG();let e=s.readUEG();for(let t=0;t<e;t++)s.readSEG()}let c=s.readUEG();s.readBits(1);let u=s.readUEG(),m=s.readUEG(),g=s.readBits(1);0===g&&s.readBits(1),s.readBits(1);let p=0,_=0,f=0,A=0;s.readBool()&&(p=s.readUEG(),_=s.readUEG(),f=s.readUEG(),A=s.readUEG());let y=1,v=1,S=0,b=!0,T=0,k=0;if(s.readBool()){if(s.readBool()){let e=s.readByte();e>0&&e<16?(y=[1,12,10,16,40,24,20,32,80,18,15,64,160,4,3,2][e-1],v=[1,11,11,11,33,11,11,11,33,11,11,33,99,3,2,1][e-1]):255===e&&(y=s.readByte()<<8|s.readByte(),v=s.readByte()<<8|s.readByte())}if(s.readBool()&&s.readBool(),s.readBool()&&(s.readBits(4),s.readBool()&&s.readBits(24)),s.readBool()&&(s.readUEG(),s.readUEG()),s.readBool()){let e=s.readBits(32),t=s.readBits(32);b=s.readBool(),T=t,k=2*e,S=T/k}}let D=1;1===y&&1===v||(D=y/v);let C=0,I=0;0===o?(C=1,I=2-g):(C=3===o?1:2,I=(1===o?2:1)*(2-g));let x=16*(u+1),L=16*(m+1)*(2-g);x-=(p+_)*C,L-=(f+A)*I;let R=Math.ceil(x*D);return s.destroy(),s=null,{profile_string:n,level_string:r,bit_depth:d,ref_frames:c,chroma_format:h,chroma_format_string:G.getChromaFormatString(h),frame_rate:{fixed:b,fps:S,fps_den:k,fps_num:T},sar_ratio:{width:y,height:v},codec_size:{width:x,height:L},present_size:{width:R,height:L}}}static _skipScalingList(e,t){let s=8,i=8,a=0;for(let n=0;n<t;n++)0!==i&&(a=e.readSEG(),i=(s+a+256)%256),s=0===i?s:i}static getProfileString(e){switch(e){case 66:return"Baseline";case 77:return"Main";case 88:return"Extended";case 100:return"High";case 110:return"High10";case 122:return"High422";case 244:return"High444";default:return"Unknown"}}static getLevelString(e){return(e/10).toFixed(1)}static getChromaFormatString(e){switch(e){case 420:return"4:2:0";case 422:return"4:2:2";case 444:return"4:4:4";default:return"Unknown"}}}const L=G;class R{static init(){R.types={avc1:[],avcC:[],btrt:[],dinf:[],dref:[],esds:[],ftyp:[],hdlr:[],mdat:[],mdhd:[],mdia:[],mfhd:[],minf:[],moof:[],moov:[],mp4a:[],mvex:[],mvhd:[],sdtp:[],stbl:[],stco:[],stsc:[],stsd:[],stsz:[],stts:[],tfdt:[],tfhd:[],traf:[],trak:[],trun:[],trex:[],tkhd:[],vmhd:[],smhd:[],".mp3":[]};for(let e in R.types)R.types.hasOwnProperty(e)&&(R.types[e]=[e.charCodeAt(0),e.charCodeAt(1),e.charCodeAt(2),e.charCodeAt(3)]);let e=R.constants={};e.FTYP=new Uint8Array([105,115,111,109,0,0,0,1,105,115,111,109,97,118,99,49]),e.STSD_PREFIX=new Uint8Array([0,0,0,0,0,0,0,1]),e.STTS=new Uint8Array([0,0,0,0,0,0,0,0]),e.STSC=e.STCO=e.STTS,e.STSZ=new Uint8Array([0,0,0,0,0,0,0,0,0,0,0,0]),e.HDLR_VIDEO=new Uint8Array([0,0,0,0,0,0,0,0,118,105,100,101,0,0,0,0,0,0,0,0,0,0,0,0,86,105,100,101,111,72,97,110,100,108,101,114,0]),e.HDLR_AUDIO=new Uint8Array([0,0,0,0,0,0,0,0,115,111,117,110,0,0,0,0,0,0,0,0,0,0,0,0,83,111,117,110,100,72,97,110,100,108,101,114,0]),e.DREF=new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,12,117,114,108,32,0,0,0,1]),e.SMHD=new Uint8Array([0,0,0,0,0,0,0,0]),e.VMHD=new Uint8Array([0,0,0,1,0,0,0,0,0,0,0,0])}static box(e){let t,s=8,i=Array.prototype.slice.call(arguments,1),a=i.length;for(let e=0;e<a;e++)s+=i[e].byteLength;t=new Uint8Array(s),t[0]=s>>>24&255,t[1]=s>>>16&255,t[2]=s>>>8&255,t[3]=255&s,t.set(e,4);let n=8;for(let e=0;e<a;e++)t.set(i[e],n),n+=i[e].byteLength;return t}static generateInitSegment(e){let t=R.box(R.types.ftyp,R.constants.FTYP),s=R.moov(e),i=new Uint8Array(t.byteLength+s.byteLength);return i.set(t,0),i.set(s,t.byteLength),i}static moov(e){let t=R.mvhd(e.timescale,e.duration),s=R.trak(e),i=R.mvex(e);return R.box(R.types.moov,t,s,i)}static mvhd(e,t){return R.box(R.types.mvhd,new Uint8Array([0,0,0,0,0,0,0,0,0,0,0,0,e>>>24&255,e>>>16&255,e>>>8&255,255&e,t>>>24&255,t>>>16&255,t>>>8&255,255&t,0,1,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,64,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,255,255,255,255]))}static trak(e){return R.box(R.types.trak,R.tkhd(e),R.mdia(e))}static tkhd(e){let t=e.id,s=e.duration,i=e.presentWidth,a=e.presentHeight;return R.box(R.types.tkhd,new Uint8Array([0,0,0,7,0,0,0,0,0,0,0,0,t>>>24&255,t>>>16&255,t>>>8&255,255&t,0,0,0,0,s>>>24&255,s>>>16&255,s>>>8&255,255&s,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,64,0,0,0,i>>>8&255,255&i,0,0,a>>>8&255,255&a,0,0]))}static mdia(e){return R.box(R.types.mdia,R.mdhd(e),R.hdlr(e),R.minf(e))}static mdhd(e){let t=e.timescale,s=e.duration;return R.box(R.types.mdhd,new Uint8Array([0,0,0,0,0,0,0,0,0,0,0,0,t>>>24&255,t>>>16&255,t>>>8&255,255&t,s>>>24&255,s>>>16&255,s>>>8&255,255&s,85,196,0,0]))}static hdlr(e){let t;return t="audio"===e.type?R.constants.HDLR_AUDIO:R.constants.HDLR_VIDEO,R.box(R.types.hdlr,t)}static minf(e){let t;return t="audio"===e.type?R.box(R.types.smhd,R.constants.SMHD):R.box(R.types.vmhd,R.constants.VMHD),R.box(R.types.minf,t,R.dinf(),R.stbl(e))}static dinf(){return R.box(R.types.dinf,R.box(R.types.dref,R.constants.DREF))}static stbl(e){return R.box(R.types.stbl,R.stsd(e),R.box(R.types.stts,R.constants.STTS),R.box(R.types.stsc,R.constants.STSC),R.box(R.types.stsz,R.constants.STSZ),R.box(R.types.stco,R.constants.STCO))}static stsd(e){return"audio"===e.type?"mp3"===e.codec?R.box(R.types.stsd,R.constants.STSD_PREFIX,R.mp3(e)):R.box(R.types.stsd,R.constants.STSD_PREFIX,R.mp4a(e)):R.box(R.types.stsd,R.constants.STSD_PREFIX,R.avc1(e))}static mp3(e){let t=e.channelCount,s=e.audioSampleRate,i=new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,t,0,16,0,0,0,0,s>>>8&255,255&s,0,0]);return R.box(R.types[".mp3"],i)}static mp4a(e){let t=e.channelCount,s=e.audioSampleRate,i=new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,t,0,16,0,0,0,0,s>>>8&255,255&s,0,0]);return R.box(R.types.mp4a,i,R.esds(e))}static esds(e){let t=e.config||[],s=t.length,i=new Uint8Array([0,0,0,0,3,23+s,0,1,0,4,15+s,64,21,0,0,0,0,0,0,0,0,0,0,0,5].concat([s]).concat(t).concat([6,1,2]));return R.box(R.types.esds,i)}static avc1(e){let t=e.avcc,s=e.codecWidth,i=e.codecHeight,a=new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,s>>>8&255,255&s,i>>>8&255,255&i,0,72,0,0,0,72,0,0,0,0,0,0,0,1,10,120,113,113,47,102,108,118,46,106,115,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,24,255,255]);return R.box(R.types.avc1,a,R.box(R.types.avcC,t))}static mvex(e){return R.box(R.types.mvex,R.trex(e))}static trex(e){let t=e.id,s=new Uint8Array([0,0,0,0,t>>>24&255,t>>>16&255,t>>>8&255,255&t,0,0,0,1,0,0,0,0,0,0,0,0,0,1,0,1]);return R.box(R.types.trex,s)}static moof(e,t){return R.box(R.types.moof,R.mfhd(e.sequenceNumber),R.traf(e,t))}static mfhd(e){let t=new Uint8Array([0,0,0,0,e>>>24&255,e>>>16&255,e>>>8&255,255&e]);return R.box(R.types.mfhd,t)}static traf(e,t){let s=e.id,i=R.box(R.types.tfhd,new Uint8Array([0,0,0,0,s>>>24&255,s>>>16&255,s>>>8&255,255&s])),a=R.box(R.types.tfdt,new Uint8Array([0,0,0,0,t>>>24&255,t>>>16&255,t>>>8&255,255&t])),n=R.sdtp(e),r=R.trun(e,n.byteLength+16+16+8+16+8+8);return R.box(R.types.traf,i,a,r,n)}static sdtp(e){let t=e.samples||[],s=t.length,i=new Uint8Array(4+s);for(let e=0;e<s;e++){let s=t[e].flags;i[e+4]=s.isLeading<<6|s.dependsOn<<4|s.isDependedOn<<2|s.hasRedundancy}return R.box(R.types.sdtp,i)}static trun(e,t){let s=e.samples||[],i=s.length,a=12+16*i,n=new Uint8Array(a);t+=8+a,n.set([0,0,15,1,i>>>24&255,i>>>16&255,i>>>8&255,255&i,t>>>24&255,t>>>16&255,t>>>8&255,255&t],0);for(let e=0;e<i;e++){let t=s[e].duration,i=s[e].size,a=s[e].flags,r=s[e].cts;n.set([t>>>24&255,t>>>16&255,t>>>8&255,255&t,i>>>24&255,i>>>16&255,i>>>8&255,255&i,a.isLeading<<2|a.dependsOn,a.isDependedOn<<6|a.hasRedundancy<<4|a.isNonSync,0,0,r>>>24&255,r>>>16&255,r>>>8&255,255&r],12+16*e)}return R.box(R.types.trun,n)}static mdat(e){return R.box(R.types.mdat,e)}}R.init();const U=R;class B{constructor(e,t,s,i,a){this.dts=e,this.pts=t,this.duration=s,this.originalDts=i,this.isSyncPoint=a,this.fileposition=null}}class E{constructor(){this.beginDts=0,this.endDts=0,this.beginPts=0,this.endPts=0,this.originalBeginDts=0,this.originalEndDts=0,this.syncPoints=[],this.firstSample=null,this.lastSample=null}appendSyncPoint(e){e.isSyncPoint=!0,this.syncPoints.push(e)}}class P{constructor(e){this._type=e,this._list=[],this._lastAppendLocation=-1}get type(){return this._type}get length(){return this._list.length}isEmpty(){return 0===this._list.length}clear(){this._list=[],this._lastAppendLocation=-1}_searchNearestSegmentBefore(e){let t=this._list;if(0===t.length)return-2;let s=t.length-1,i=0,a=0,n=s,r=0;if(e<t[0].originalBeginDts)return r=-1,r;for(;a<=n;){if(i=a+Math.floor((n-a)/2),i===s||e>t[i].lastSample.originalDts&&e<t[i+1].originalBeginDts){r=i;break}t[i].originalBeginDts<e?a=i+1:n=i-1}return r}_searchNearestSegmentAfter(e){return this._searchNearestSegmentBefore(e)+1}append(e){let t=this._list,s=e,i=this._lastAppendLocation,a=0;-1!==i&&i<t.length&&s.originalBeginDts>=t[i].lastSample.originalDts&&(i===t.length-1||i<t.length-1&&s.originalBeginDts<t[i+1].originalBeginDts)?a=i+1:t.length>0&&(a=this._searchNearestSegmentBefore(s.originalBeginDts)+1),this._lastAppendLocation=a,this._list.splice(a,0,s)}getLastSegmentBefore(e){let t=this._searchNearestSegmentBefore(e);return t>=0?this._list[t]:null}getLastSampleBefore(e){let t=this.getLastSegmentBefore(e);return null!=t?t.lastSample:null}getLastSyncPointBefore(e){let t=this._searchNearestSegmentBefore(e),s=this._list[t].syncPoints;for(;0===s.length&&t>0;)t--,s=this._list[t].syncPoints;return s.length>0?s[s.length-1]:null}}const F=class{static getSilentFrame(e,t){if("mp4a.40.2"===e){if(1===t)return new Uint8Array([0,200,0,128,35,128]);if(2===t)return new Uint8Array([33,0,73,144,2,25,0,35,128]);if(3===t)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,142]);if(4===t)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,128,44,128,8,2,56]);if(5===t)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,130,48,4,153,0,33,144,2,56]);if(6===t)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,130,48,4,153,0,33,144,2,0,178,0,32,8,224])}else{if(1===t)return new Uint8Array([1,64,34,128,163,78,230,128,186,8,0,0,0,28,6,241,193,10,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,94]);if(2===t)return new Uint8Array([1,64,34,128,163,94,230,128,186,8,0,0,0,0,149,0,6,241,161,10,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,94]);if(3===t)return new Uint8Array([1,64,34,128,163,94,230,128,186,8,0,0,0,0,149,0,6,241,161,10,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,94])}return null}};let V={};!function(){let e=self.navigator.userAgent.toLowerCase(),t=/(edge)\/([\w.]+)/.exec(e)||/(opr)[\/]([\w.]+)/.exec(e)||/(chrome)[ \/]([\w.]+)/.exec(e)||/(iemobile)[\/]([\w.]+)/.exec(e)||/(version)(applewebkit)[ \/]([\w.]+).*(safari)[ \/]([\w.]+)/.exec(e)||/(webkit)[ \/]([\w.]+).*(version)[ \/]([\w.]+).*(safari)[ \/]([\w.]+)/.exec(e)||/(webkit)[ \/]([\w.]+)/.exec(e)||/(opera)(?:.*version|)[ \/]([\w.]+)/.exec(e)||/(msie) ([\w.]+)/.exec(e)||e.indexOf("trident")>=0&&/(rv)(?::| )([\w.]+)/.exec(e)||e.indexOf("compatible")<0&&/(firefox)[ \/]([\w.]+)/.exec(e)||[],s=/(ipad)/.exec(e)||/(ipod)/.exec(e)||/(windows phone)/.exec(e)||/(iphone)/.exec(e)||/(kindle)/.exec(e)||/(android)/.exec(e)||/(windows)/.exec(e)||/(mac)/.exec(e)||/(linux)/.exec(e)||/(cros)/.exec(e)||[],i={browser:t[5]||t[3]||t[1]||"",version:t[2]||t[4]||"0",majorVersion:t[4]||t[2]||"0",platform:s[0]||""},a={};if(i.browser){a[i.browser]=!0;let e=i.majorVersion.split(".");a.version={major:parseInt(i.majorVersion,10),string:i.version},e.length>1&&(a.version.minor=parseInt(e[1],10)),e.length>2&&(a.version.build=parseInt(e[2],10))}if(i.platform&&(a[i.platform]=!0),(a.chrome||a.opr||a.safari)&&(a.webkit=!0),a.rv||a.iemobile){a.rv&&delete a.rv;let e="msie";i.browser=e,a[e]=!0}if(a.edge){delete a.edge;let e="msedge";i.browser=e,a[e]=!0}if(a.opr){let e="opera";i.browser=e,a[e]=!0}if(a.safari&&a.android){let e="android";i.browser=e,a[e]=!0}a.name=i.browser,a.platform=i.platform;for(let e in V)V.hasOwnProperty(e)&&delete V[e];Object.assign(V,a)}();const O=V,N=class{TAG="AMF0Object";data;params;constructor(e){e&&(this.params=e,t.d(this.TAG,"cmd: "+this.params[0]))}parseAMF0(e){this.data=Array.from(e);let s=[];for(;this.data.length>0;){const e=this.data.shift();switch(e){case 0:s.push(r(this.data.slice(0,8))),this.data=this.data.slice(8);break;case 1:0===this.data.shift()?s.push(!1):s.push(!0);break;case 2:let i=this.data[0]<<8|this.data[1];this.data=this.data.slice(2),s.push(o(this.data.slice(0,i))),this.data=this.data.slice(i);break;case 3:s.push(this._parseAMF0Object());break;case 5:s.push(null);break;default:t.w(this.TAG,"var_type: "+e+" not yet implemented")}}return this.params=s,s}_parseAMF0Object(){let e={};for(;this.data.length>0;){let s=this.data[0]<<8|this.data[1];if(this.data=this.data.slice(2),0===s&&9===this.data[0])return this.data=this.data.slice(1),e;let i=o(this.data.slice(0,s));this.data=this.data.slice(s);const a=this.data.shift();switch(a){case 0:e[i]=r(this.data.slice(0,8)),this.data=this.data.slice(8);break;case 1:0===this.data.shift()?e[i]=!1:e[i]=!0;break;case 2:let s=this.data[0]<<8|this.data[1];this.data=this.data.slice(2),e[i]=o(this.data.slice(0,s)),this.data=this.data.slice(s);break;case 5:e[i]=null;break;default:t.w(this.TAG,"var_type: "+a+" not yet implemented")}}return e}getBytes(){let e=[];for(let s=0;s<this.params.length;s++){const i=this.params[s];switch(typeof i){case"string":e.push(2),e.push(i.length>>>8),e.push(i.length),e=e.concat(a(i));break;case"number":e.push(0),e=e.concat(n(i));break;case"object":e.push(3);for(let s in i){let r=i[s],o=s.length;switch(e.push(o>>>8),e.push(o),e=e.concat(a(s)),typeof r){case"object":null==r&&e.push(5);break;case"string":const s=r.length;e.push(2),e.push(s>>>8),e.push(s),e=e.concat(a(r));break;case"number":e.push(0),e=e.concat(n(r));break;case"boolean":e.push(1),r?e.push(1):e.push(0);break;default:t.w(this.TAG,typeof r," not yet implementd")}}e.push(0),e.push(0),e.push(9);break;case"boolean":e.push(1),i?e.push(1):e.push(0);break;default:t.w(this.TAG,typeof i," not yet implementd")}}return new Uint8Array(e)}getCommand(){return this.params[0]}getTransactionId(){return this.params[1]}getCommandObject(){return this.params[2]}getAdditionalInfo(){return this.params[3]}},z="WebRTMP Worker";let H,j,W;t.LEVEL=t.DEBUG;const K=new class{TAG="WSSConnectionManager";host;port;wss;open(e,s,i){this.host=e,t.v(this.TAG,"connecting to: "+e+":"+s),this.wss=new WebSocket("wss://"+e+":"+s+"/"),this.wss.binaryType="arraybuffer",this.wss.onopen=e=>{t.v(this.TAG,e),i(!0)},this.wss.onclose=e=>{t.w(this.TAG,e),postMessage(["ConnectionLost"])},this.wss.onerror=e=>{t.e(this.TAG,e),i(!1)}}registerMessageHandler(e){this.wss.onmessage=e}getSocket(){return this.wss}getHost(){return this.host}close(){this.wss.close()}};self.addEventListener("message",(function(e){let i=e.data;switch(t.d(z,"CMD: "+i.cmd),i.cmd){case"open":j=i.host,H=i.port,K.open(j,H,(e=>{if(t.v(z,"open: "+j+":"+H),e){t.v(z,"WSSConnected"),postMessage(["WSSConnected"]);const e=new class{TAG="RTMPHandshake";state=0;onHandshakeDone=null;c1;c2;constructor(e){this.socket=e,this.socket.onmessage=e=>{t.v(this.TAG,e.data),this.processServerInput(new Uint8Array(e.data))}}do(){this.onHandshakeDone?(t.v(this.TAG,"send C0"),this.socket.send(new Uint8Array([3])),this.state=1,t.v(this.TAG,"send C1"),this.socket.send(this._generateC1()),this.state=2):t.e(this.TAG,"onHandshakeDone not defined")}_generateC1(){const e=new Uint8Array(1536);for(let t=0;t<e.length;t++)e[t]=Math.floor(256*Math.random());let t=Math.round(Date.now()/1e3);return e[0]=t>>>24,e[1]=t>>>16,e[2]=t>>>8,e[3]=t,e[4]=0,e[5]=0,e[6]=0,e[7]=0,this.c1=e,e}_generateC2(e){return this.c2=e,this.c2}_parseS0(e){t.v(this.TAG,"S0: ",e),3!==e[0]?t.e(this.TAG,"S0 response not 0x03"):t.v(this.TAG,"1st Byte OK"),this.state=3,e.length>1&&(t.v(this.TAG,"S1 included"),this._parseS1(e.slice(1)))}_parseS1(e){t.v(this.TAG,"parse S1: ",e),this.state=4;let s=e.slice(0,1536);t.v(this.TAG,"send C2"),this.socket.send(this._generateC2(s)),this.state=5,e.length>1536&&(t.v(this.TAG,"S2 included: "+e.length),this._parseS2(e.slice(1536)))}_parseS2(e){if(t.v(this.TAG,"parse S2: ",e),!this._compare(this.c1,e))return t.e(this.TAG,"C1 S1 not equal"),void this.onHandshakeDone(!1);this.state=6,t.v(this.TAG,"RTMP Connection established"),this.onHandshakeDone(!0)}_compare(e,t){for(let s=0;s<e.length;s++)if(e[s]!==t[s])return!1;return!0}processServerInput(e){switch(this.state){case 2:this._parseS0(e);break;case 3:this._parseS1(e);break;case 5:this._parseS2(e)}}}(K.getSocket());e.onHandshakeDone=e=>{e?(W=new class{TAG="RTMPMessageHandler";netconnections={};chunk_stream_id=2;trackedCommand="";socket;constructor(e){this.socket=e,this.chunk_parser=new class{TAG="ChunkParser";static CHUNK_SIZE=128;chunkstreams=[];buffer=new Uint8Array(0);constructor(e){this.conn_worker=e}parseChunk(e){let i,a,n;this.buffer=s(this.buffer,e);do{t.d(this.TAG,"buffer length: "+this.buffer.length),this.buffer.length<100&&t.d(this.TAG,this.buffer);let e=this.buffer,s=0,r=0,o=0;n=(192&e[0])>>>6;let h,d=63&e[s++];switch(0===d?d=e[s++]+64:1===d&&(d=256*e[s++]+e[s++]+64),t.d(this.TAG,"chunk type: ",n," StreamID: "+d),n){case 0:a=e[s++]<<16|e[s++]<<8|e[s++],r=e[s++]<<16|e[s++]<<8|e[s++],i=new _,i.setMessageType(e[s++]),i.setMessageStreamID(e[s++]<<24|e[s++]<<16|e[s++]<<8|e[s++]),i.setMessageLength(r),16777215===a&&(a=e[s++]<<24|e[s++]<<16|e[s++]<<8|e[s++],i.setExtendedTimestamp(!0)),i.setMessageTimestamp(a),t.d(this.TAG,"message_length: "+r),this.chunkstreams[d]=i;break;case 1:a=e[s++]<<16|e[s++]<<8|e[s++],r=e[s++]<<16|e[s++]<<8|e[s++],i=this.chunkstreams[d],i.setMessageType(e[s++]),i.setMessageLength(r),16777215===a?(a=e[s++]<<24|e[s++]<<16|e[s++]<<8|e[s++],i.setExtendedTimestamp(!0)):i.setExtendedTimestamp(!1),i.setTimestampDelta(a),t.d(this.TAG,"message_length: "+r),this.chunkstreams[d]=i;break;case 2:a=e[s++]<<16|e[s++]<<8|e[s++],i=this.chunkstreams[d],16777215===a?(a=e[s++]<<24|e[s++]<<16|e[s++]<<8|e[s++],i.setExtendedTimestamp(!0)):i.setExtendedTimestamp(!1),i.setTimestampDelta(a);break;case 3:i=this.chunkstreams[d],i.getExtendedTimestamp()&&(a=e[s++]<<24|e[s++]<<16|e[s++]<<8|e[s++],i.setTimestampDelta(a))}if(i||t.e(this.TAG,"No suitable RTMPMessage found"),o=this.chunkstreams[d].bytesMissing(),o>this.CHUNK_SIZE&&(o=this.CHUNK_SIZE),h=e.slice(s,s+o),h.length<o)return void t.d(this.TAG,"packet("+h.length+"/"+o+") too small, wait for next");this.chunkstreams[d].addPayload(h),this.chunkstreams[d].isComplete()&&(t.d(this.TAG,"RTMP: ",i.getMessageType(),_.MessageTypes[i.getMessageType()],i.getPayloadlength(),i.getMessageStreamID()),this.conn_worker.onMessage(this.chunkstreams[d]),this.chunkstreams[d].clearPayload());let l=s+o;l>this.buffer.length&&t.w(this.TAG,"mehr abschneiden als da"),this.buffer=this.buffer.slice(l),t.d(this.TAG,"consumed: "+l+" bytes, rest: "+this.buffer.length)}while(this.buffer.length>11);t.d(this.TAG,"parseChunk complete")}setChunkSize(e){t.d(this.TAG,"SetChunkSize: "+e),this.CHUNK_SIZE=e}}(this),this.media_handler=new class{TAG="RTMPMediaMessageHandler";constructor(e){this._config=e,this._onError=null,this._onMediaInfo=null,this._onMetaDataArrived=null,this._onScriptDataArrived=null,this._onDataAvailable=null,this._onTrackMetadata=null,this._dispatch=!1,this._hasAudio=!0,this._hasVideo=!0,this._hasAudioFlagOverrided=!1,this._hasVideoFlagOverrided=!1,this._audioInitialMetadataDispatched=!1,this._videoInitialMetadataDispatched=!1,this._mediaInfo=new T,this._mediaInfo.hasAudio=this._hasAudio,this._mediaInfo.hasVideo=this._hasVideo,this._metadata=null,this._audioMetadata=null,this._videoMetadata=null,this._naluLengthSize=4,this._timestampBase=0,this._timescale=1e3,this._duration=0,this._durationOverrided=!1,this._referenceFrameRate={fixed:!0,fps:23.976,fps_num:23976,fps_den:1e3},this._flvSoundRateTable=[5500,11025,22050,44100,48e3],this._mpegSamplingRates=[96e3,88200,64e3,48e3,44100,32e3,24e3,22050,16e3,12e3,11025,8e3,7350],this._mpegAudioV10SampleRateTable=[44100,48e3,32e3,0],this._mpegAudioV20SampleRateTable=[22050,24e3,16e3,0],this._mpegAudioV25SampleRateTable=[11025,12e3,8e3,0],this._mpegAudioL1BitRateTable=[0,32,64,96,128,160,192,224,256,288,320,352,384,416,448,-1],this._mpegAudioL2BitRateTable=[0,32,48,56,64,80,96,112,128,160,192,224,256,320,384,-1],this._mpegAudioL3BitRateTable=[0,32,40,48,56,64,80,96,112,128,160,192,224,256,320,-1],this._videoTrack={type:"video",id:1,sequenceNumber:0,samples:[],length:0},this._audioTrack={type:"audio",id:2,sequenceNumber:0,samples:[],length:0},this._littleEndian=function(){let e=new ArrayBuffer(2);return new DataView(e).setInt16(0,256,!0),256===new Int16Array(e)[0]}(),this.bytePos=0,this._config=h,this._transmuxer=new class{TAG="Transmuxer";constructor(e){this._emitter=new class{ListenerList=[];TAG="EventEmitter";constructor(){}addEventListener(e,t){this.ListenerList.push([e,t])}addListener(e,t){this.ListenerList.push([e,t])}removeListener(e,t){for(let s=0;s<this.ListenerList.length;s++){let i=this.ListenerList[s];if(i[0]==e&&i[1]==t)return void this.ListenerList.splice(s,1)}}removeAllListeners(){this.ListenerList=[]}emit(e,...s){t.t(this.TAG,"emit EVENT: "+e,...s);for(let t=0;t<this.ListenerList.length;t++){let i=this.ListenerList[t];i[0]===e&&i[1].call(this,...s)}}},this._config=e,this._currentSegmentIndex=0,this._mediaInfo=null,this._ioctl=null,this._pendingSeekTime=null,this._pendingResolveSeekPoint=null,this._statisticsReporter=null,this._remuxer=new class{TAG="MP4Remuxer";constructor(e){this._config=e,this._isLive=!0===e.isLive,this._dtsBase=-1,this._dtsBaseInited=!1,this._audioDtsBase=1/0,this._videoDtsBase=1/0,this._audioNextDts=void 0,this._videoNextDts=void 0,this._audioStashedLastSample=null,this._videoStashedLastSample=null,this._audioMeta=null,this._videoMeta=null,this._audioSegmentInfoList=new P("audio"),this._videoSegmentInfoList=new P("video"),this._onInitSegment=null,this._onMediaSegment=null,this._forceFirstIDR=!(!O.chrome||!(O.version.major<50||50===O.version.major&&O.version.build<2661)),this._fillSilentAfterSeek=O.msedge||O.msie,this._mp3UseMpegAudio=!O.firefox,this._fillAudioTimestampGap=this._config.fixAudioTimestampGap}destroy(){this._dtsBase=-1,this._dtsBaseInited=!1,this._audioMeta=null,this._videoMeta=null,this._audioSegmentInfoList.clear(),this._audioSegmentInfoList=null,this._videoSegmentInfoList.clear(),this._videoSegmentInfoList=null,this._onInitSegment=null,this._onMediaSegment=null}get onInitSegment(){return this._onInitSegment}set onInitSegment(e){this._onInitSegment=e}get onMediaSegment(){return this._onMediaSegment}set onMediaSegment(e){this._onMediaSegment=e}insertDiscontinuity(){this._audioNextDts=this._videoNextDts=void 0}seek(e){this._audioStashedLastSample=null,this._videoStashedLastSample=null,this._videoSegmentInfoList.clear(),this._audioSegmentInfoList.clear()}remux(e,t){if(!this._onMediaSegment)throw new w("MP4Remuxer: onMediaSegment callback must be specificed!");this._dtsBaseInited||this._calculateDtsBase(e,t),this._remuxVideo(t),this._remuxAudio(e)}_onTrackMetadataReceived(e,s){t.i(this.TAG,"_onTrackMetadataReceived");let i=null,a="mp4",n=s.codec;if("audio"===e)this._audioMeta=s,"mp3"===s.codec&&this._mp3UseMpegAudio?(a="mpeg",n="",i=new Uint8Array(0)):i=U.generateInitSegment(s);else{if("video"!==e)return;this._videoMeta=s,i=U.generateInitSegment(s)}if(!this._onInitSegment)throw new w("MP4Remuxer: onInitSegment callback must be specified!");this._onInitSegment(e,{type:e,data:i.buffer,codec:n,container:`${e}/${a}`,mediaDuration:s.duration})}_calculateDtsBase(e,t){this._dtsBaseInited||(e.samples&&e.samples.length&&(this._audioDtsBase=e.samples[0].dts),t.samples&&t.samples.length&&(this._videoDtsBase=t.samples[0].dts),this._dtsBase=Math.min(this._audioDtsBase,this._videoDtsBase),this._dtsBaseInited=!0)}flushStashedSamples(){let e=this._videoStashedLastSample,t=this._audioStashedLastSample,s={type:"video",id:1,sequenceNumber:0,samples:[],length:0};null!=e&&(s.samples.push(e),s.length=e.length);let i={type:"audio",id:2,sequenceNumber:0,samples:[],length:0};null!=t&&(i.samples.push(t),i.length=t.length),this._videoStashedLastSample=null,this._audioStashedLastSample=null,this._remuxVideo(s,!0),this._remuxAudio(i,!0)}_remuxAudio(e,s){if(t.i(this.TAG,"_remuxAudio"),null==this._audioMeta)return void t.w(this.TAG,"no audioMeta");let i,a=e,n=a.samples,r=-1,o=-1,h=this._audioMeta.refSampleDuration,d="mp3"===this._audioMeta.codec&&this._mp3UseMpegAudio,l=this._dtsBaseInited&&void 0===this._audioNextDts,c=!1;if(!n||0===n.length)return void t.w(this.TAG,"no samples");if(1===n.length&&!s)return void t.w(this.TAG,"1 sample");let u=0,m=null,g=0;d?(u=0,g=a.length):(u=8,g=8+a.length);let p=null;if(n.length>1&&(p=n.pop(),g-=p.length),null!=this._audioStashedLastSample){let e=this._audioStashedLastSample;this._audioStashedLastSample=null,n.unshift(e),g+=e.length}null!=p&&(this._audioStashedLastSample=p);let _=n[0].dts-this._dtsBase;if(this._audioNextDts)i=_-this._audioNextDts;else if(this._audioSegmentInfoList.isEmpty())i=0,this._fillSilentAfterSeek&&!this._videoSegmentInfoList.isEmpty()&&"mp3"!==this._audioMeta.originalCodec&&(c=!0);else{let e=this._audioSegmentInfoList.getLastSampleBefore(_);if(null!=e){let t=_-(e.originalDts+e.duration);t<=3&&(t=0),i=_-(e.dts+e.duration+t)}else i=0}if(c){let e=_-i,s=this._videoSegmentInfoList.getLastSegmentBefore(_);if(null!=s&&s.beginDts<e){let i=F.getSilentFrame(this._audioMeta.originalCodec,this._audioMeta.channelCount);if(i){let a=s.beginDts,r=e-s.beginDts;t.v(this.TAG,`InsertPrefixSilentAudio: dts: ${a}, duration: ${r}`),n.unshift({unit:i,dts:a,pts:a}),g+=i.byteLength}}else c=!1}let f=[];for(let e=0;e<n.length;e++){let s=n[e],a=s.unit,o=s.dts-this._dtsBase,d=o,l=!1,c=null,u=0;if(!(o<-.001)){if("mp3"!==this._audioMeta.codec){let e=o;const s=3;if(this._audioNextDts&&(e=this._audioNextDts),i=o-e,i<=-s*h){t.w(this.TAG,`Dropping 1 audio frame (originalDts: ${o} ms ,curRefDts: ${e} ms)  due to dtsCorrection: ${i} ms overlap.`);continue}if(i>=s*h&&this._fillAudioTimestampGap&&!O.safari){l=!0;let s=Math.floor(i/h);t.w(this.TAG,`Large audio timestamp gap detected, may cause AV sync to drift. Silent frames will be generated to avoid unsync.\noriginalDts: ${o} ms, curRefDts: ${e} ms, dtsCorrection: ${Math.round(i)} ms, generate: ${s} frames`),d=Math.floor(e),u=Math.floor(e+h)-d;let n=F.getSilentFrame(this._audioMeta.originalCodec,this._audioMeta.channelCount);null==n&&(t.w(this.TAG,`Unable to generate silent frame for ${this._audioMeta.originalCodec} with ${this._audioMeta.channelCount} channels, repeat last frame`),n=a),c=[];for(let t=0;t<s;t++){e+=h;let t=Math.floor(e),s=Math.floor(e+h)-t,i={dts:t,pts:t,cts:0,unit:n,size:n.byteLength,duration:s,originalDts:o,flags:{isLeading:0,dependsOn:1,isDependedOn:0,hasRedundancy:0}};c.push(i),g+=i.size}this._audioNextDts=e+h}else d=Math.floor(e),u=Math.floor(e+h)-d,this._audioNextDts=e+h}else d=o-i,u=e!==n.length-1?n[e+1].dts-this._dtsBase-i-d:null!=p?p.dts-this._dtsBase-i-d:f.length>=1?f[f.length-1].duration:Math.floor(h),this._audioNextDts=d+u;-1===r&&(r=d),f.push({dts:d,pts:d,cts:0,unit:s.unit,size:s.unit.byteLength,duration:u,originalDts:o,flags:{isLeading:0,dependsOn:1,isDependedOn:0,hasRedundancy:0}}),l&&f.push.apply(f,c)}}if(0===f.length)return a.samples=[],a.length=0,void t.w(this.TAG,"no mp4Samples = 0");d?m=new Uint8Array(g):(m=new Uint8Array(g),m[0]=g>>>24&255,m[1]=g>>>16&255,m[2]=g>>>8&255,m[3]=255&g,m.set(U.types.mdat,4));for(let e=0;e<f.length;e++){let t=f[e].unit;m.set(t,u),u+=t.byteLength}let A=f[f.length-1];o=A.dts+A.duration;let y,v=new E;v.beginDts=r,v.endDts=o,v.beginPts=r,v.endPts=o,v.originalBeginDts=f[0].originalDts,v.originalEndDts=A.originalDts+A.duration,v.firstSample=new B(f[0].dts,f[0].pts,f[0].duration,f[0].originalDts,!1),v.lastSample=new B(A.dts,A.pts,A.duration,A.originalDts,!1),this._isLive||this._audioSegmentInfoList.append(v),a.samples=f,a.sequenceNumber++,y=d?new Uint8Array(0):U.moof(a,r),a.samples=[],a.length=0;let S={type:"audio",data:this._mergeBoxes(y,m).buffer,sampleCount:f.length,info:v};d&&l&&(S.timestampOffset=r),t.i(this.TAG,"send onMediaSegment audio"),this._onMediaSegment("audio",S)}_remuxVideo(e,s){if(t.i(this.TAG,"_remuxVideo"),null==this._videoMeta)return;let i,a=e,n=a.samples,r=-1,o=-1,h=-1,d=-1;if(!n||0===n.length)return void t.w(this.TAG,"no samples");if(1===n.length&&!s)return void t.w(this.TAG,"no sampes = 1");let l=8,c=null,u=8+e.length,m=null;if(n.length>1&&(m=n.pop(),u-=m.length),null!=this._videoStashedLastSample){let e=this._videoStashedLastSample;this._videoStashedLastSample=null,n.unshift(e),u+=e.length}null!=m&&(this._videoStashedLastSample=m);let g=n[0].dts-this._dtsBase;if(this._videoNextDts)i=g-this._videoNextDts;else if(this._videoSegmentInfoList.isEmpty())i=0;else{let e=this._videoSegmentInfoList.getLastSampleBefore(g);if(null!=e){let t=g-(e.originalDts+e.duration);t<=3&&(t=0),i=g-(e.dts+e.duration+t)}else i=0}let p=new E,_=[];for(let e=0;e<n.length;e++){let t=n[e],s=t.dts-this._dtsBase,a=t.isKeyframe,o=s-i,d=t.cts,l=o+d;-1===r&&(r=o,h=l);let c=0;if(c=e!==n.length-1?n[e+1].dts-this._dtsBase-i-o:null!=m?m.dts-this._dtsBase-i-o:_.length>=1?_[_.length-1].duration:Math.floor(this._videoMeta.refSampleDuration),a){let e=new B(o,l,c,t.dts,!0);e.fileposition=t.fileposition,p.appendSyncPoint(e)}_.push({dts:o,pts:l,cts:d,units:t.units,size:t.length,isKeyframe:a,duration:c,originalDts:s,flags:{isLeading:0,dependsOn:a?2:1,isDependedOn:a?1:0,hasRedundancy:0,isNonSync:a?0:1}})}c=new Uint8Array(u),c[0]=u>>>24&255,c[1]=u>>>16&255,c[2]=u>>>8&255,c[3]=255&u,c.set(U.types.mdat,4);for(let e=0;e<_.length;e++){let t=_[e].units;for(;t.length;){let e=t.shift().data;c.set(e,l),l+=e.byteLength}}let f=_[_.length-1];if(o=f.dts+f.duration,d=f.pts+f.duration,this._videoNextDts=o,p.beginDts=r,p.endDts=o,p.beginPts=h,p.endPts=d,p.originalBeginDts=_[0].originalDts,p.originalEndDts=f.originalDts+f.duration,p.firstSample=new B(_[0].dts,_[0].pts,_[0].duration,_[0].originalDts,_[0].isKeyframe),p.lastSample=new B(f.dts,f.pts,f.duration,f.originalDts,f.isKeyframe),this._isLive||this._videoSegmentInfoList.append(p),a.samples=_,a.sequenceNumber++,this._forceFirstIDR){let e=_[0].flags;e.dependsOn=2,e.isNonSync=0}let A=U.moof(a,r);a.samples=[],a.length=0,t.i(this.TAG,"send onMediaSegment video"),this._onMediaSegment("video",{type:"video",data:this._mergeBoxes(A,c).buffer,sampleCount:_.length,info:p})}_mergeBoxes(e,t){let s=new Uint8Array(e.byteLength+t.byteLength);return s.set(e,0),s.set(t,e.byteLength),s}}(this._config),this._remuxer.onInitSegment=this._onRemuxerInitSegmentArrival.bind(this),this._remuxer.onMediaSegment=this._onRemuxerMediaSegmentArrival.bind(this)}destroy(){this._mediaInfo=null,this._mediaDataSource=null,this._statisticsReporter&&this._disableStatisticsReporter(),this._ioctl&&(this._ioctl.destroy(),this._ioctl=null),this._remuxer&&(this._remuxer.destroy(),this._remuxer=null),this._emitter.removeAllListeners(),this._emitter=null}on(e,t){this._emitter.addListener(e,t)}off(e,t){this._emitter.removeListener(e,t)}remux(e,t){this._remuxer.remux(e,t)}_onTrackMetadataReceived(e,t){this._remuxer._onTrackMetadataReceived(e,t)}stop(){this._internalAbort()}_internalAbort(){this._ioctl&&(this._ioctl.destroy(),this._ioctl=null)}_searchSegmentIndexContains(e){let t=this._mediaDataSource.segments,s=t.length-1;for(let i=0;i<t.length;i++)if(e<t[i].timestampBase){s=i-1;break}return s}_onMediaInfo(e){null==this._mediaInfo&&(this._mediaInfo=Object.assign({},e),this._mediaInfo.keyframesIndex=null,this._mediaInfo.segments=[],Object.setPrototypeOf(this._mediaInfo,T.prototype));let t=Object.assign({},e);Object.setPrototypeOf(t,T.prototype),this._mediaInfo.segments[this._currentSegmentIndex]=t,this._reportSegmentMediaInfo(this._currentSegmentIndex)}_onMetaDataArrived(e){this._emitter.emit(u,e)}_onScriptDataArrived(e){this._emitter.emit(m,e)}_onRemuxerInitSegmentArrival(e,t){this._emitter.emit(d,e,t)}_onRemuxerMediaSegmentArrival(e,s){if(t.d(this.TAG,"_onRemuxerMediaSegmentArrival"),null==this._pendingSeekTime&&(this._emitter.emit(l,e,s),null!=this._pendingResolveSeekPoint&&"video"===e)){let e=s.info.syncPoints,t=this._pendingResolveSeekPoint;this._pendingResolveSeekPoint=null,O.safari&&e.length>0&&e[0].originalDts===t&&(t=e[0].pts),this._emitter.emit("recommend_seekpoint",t)}}}(this._config),this._transmuxer.on(d,((e,t)=>{postMessage([d,e,t])})),this._transmuxer.on(l,((e,t)=>{postMessage([l,e,t])})),this._transmuxer.on(c,(e=>{this._mediaInfo=e,postMessage([c,e])})),this._transmuxer.on(u,(e=>{postMessage([u,e])})),this._transmuxer.on(m,(e=>{postMessage([m,e])})),this._onDataAvailable=(e,s)=>{t.d(this.TAG,"_onDataAvailable"),this._transmuxer.remux(e,s)},this._onTrackMetadata=(e,s)=>{t.d(this.TAG,"_onTrackMetadata"),this._transmuxer._onTrackMetadataReceived(e,s)}}destroy(){this._mediaInfo=null,this._metadata=null,this._audioMetadata=null,this._videoMetadata=null,this._videoTrack=null,this._audioTrack=null,this._onError=null,this._onMediaInfo=null,this._onMetaDataArrived=null,this._onScriptDataArrived=null,this._onTrackMetadata=null,this._onDataAvailable=null}get onTrackMetadata(){return this._onTrackMetadata}set onTrackMetadata(e){this._onTrackMetadata=e}get onMediaInfo(){return this._onMediaInfo}set onMediaInfo(e){this._onMediaInfo=e}get onMetaDataArrived(){return this._onMetaDataArrived}set onMetaDataArrived(e){this._onMetaDataArrived=e}get onScriptDataArrived(){return this._onScriptDataArrived}set onScriptDataArrived(e){this._onScriptDataArrived=e}get onError(){return this._onError}set onError(e){this._onError=e}get onDataAvailable(){return this._onDataAvailable}set onDataAvailable(e){this._onDataAvailable=e}get timestampBase(){return this._timestampBase}set timestampBase(e){this._timestampBase=e}get overridedDuration(){return this._duration}set overridedDuration(e){this._durationOverrided=!0,this._duration=e,this._mediaInfo.duration=e}set overridedHasAudio(e){this._hasAudioFlagOverrided=!0,this._hasAudio=e,this._mediaInfo.hasAudio=e}set overridedHasVideo(e){this._hasVideoFlagOverrided=!0,this._hasVideo=e,this._mediaInfo.hasVideo=e}resetMediaInfo(){this._mediaInfo=new T}_isInitialMetadataDispatched(){return this._hasAudio&&this._hasVideo?this._audioInitialMetadataDispatched&&this._videoInitialMetadataDispatched:this._hasAudio&&!this._hasVideo?this._audioInitialMetadataDispatched:!(this._hasAudio||!this._hasVideo)&&this._videoInitialMetadataDispatched}handleMediaMessage(e){if(t.d(this.TAG,"handleMediaMessage",e.getMessageType()),!(this._onError&&this._onMediaInfo&&this._onTrackMetadata&&this._onDataAvailable))throw new w("Flv: onError & onMediaInfo & onTrackMetadata & onDataAvailable callback must be specified");this._dispatch=!0;let s=e.getMessageType(),i=e.getTimestamp();switch(0!==e.getMessageStreamID()&&t.w(this.TAG,"Meet tag which has StreamID != 0!"),t.d(this.TAG,e),s){case 8:this._parseAudioData(e.getPayload(),i);break;case 9:this._parseVideoData(e.getPayload(),i,this.bytePos);break;case 18:this._parseScriptData(e.getPayload())}this.bytePos+=e.getMessageLength()+11+1,this._isInitialMetadataDispatched()&&this._dispatch&&(this._audioTrack.length||this._videoTrack.length)&&(t.i(this.TAG,"sedn2"),this._onDataAvailable(this._audioTrack,this._videoTrack))}_parseScriptData(e){let s=x.parseScriptData(e);if(s.hasOwnProperty("onMetaData")){if(null==s.onMetaData||"object"!=typeof s.onMetaData)return void t.w(this.TAG,"Invalid onMetaData structure!");this._metadata&&t.w(this.TAG,"Found another onMetaData tag!"),this._metadata=s;let e=this._metadata.onMetaData;if(this._onMetaDataArrived&&this._onMetaDataArrived(Object.assign({},e)),"boolean"==typeof e.hasAudio&&!1===this._hasAudioFlagOverrided&&(this._hasAudio=e.hasAudio,this._mediaInfo.hasAudio=this._hasAudio),"boolean"==typeof e.hasVideo&&!1===this._hasVideoFlagOverrided&&(this._hasVideo=e.hasVideo,this._mediaInfo.hasVideo=this._hasVideo),"number"==typeof e.audiodatarate&&(this._mediaInfo.audioDataRate=e.audiodatarate),"number"==typeof e.videodatarate&&(this._mediaInfo.videoDataRate=e.videodatarate),"number"==typeof e.width&&(this._mediaInfo.width=e.width),"number"==typeof e.height&&(this._mediaInfo.height=e.height),"number"==typeof e.duration){if(!this._durationOverrided){let t=Math.floor(e.duration*this._timescale);this._duration=t,this._mediaInfo.duration=t}}else this._mediaInfo.duration=0;if("number"==typeof e.framerate){let t=Math.floor(1e3*e.framerate);if(t>0){let e=t/1e3;this._referenceFrameRate.fixed=!0,this._referenceFrameRate.fps=e,this._referenceFrameRate.fps_num=t,this._referenceFrameRate.fps_den=1e3,this._mediaInfo.fps=e}}if("object"==typeof e.keyframes){this._mediaInfo.hasKeyframesIndex=!0;let t=e.keyframes;this._mediaInfo.keyframesIndex=this._parseKeyframesIndex(t),e.keyframes=null}else this._mediaInfo.hasKeyframesIndex=!1;this._dispatch=!1,this._mediaInfo.metadata=e,t.v(this.TAG,"Parsed onMetaData"),this._mediaInfo.isComplete()&&this._onMediaInfo(this._mediaInfo)}Object.keys(s).length>0&&this._onScriptDataArrived&&this._onScriptDataArrived(Object.assign({},s))}_parseKeyframesIndex(e){let t=[],s=[];for(let i=1;i<e.times.length;i++){let a=this._timestampBase+Math.floor(1e3*e.times[i]);t.push(a),s.push(e.filepositions[i])}return{times:t,filepositions:s}}_parseAudioData(e,s){if(t.d(this.TAG,"_parseAudioData",s),e.length<=1)return void t.w(this.TAG,"Flv: Invalid audio packet, missing SoundData payload!");if(!0===this._hasAudioFlagOverrided&&!1===this._hasAudio)return;this._littleEndian;let i=new DataView(e.buffer).getUint8(0),a=i>>>4;if(2!==a&&10!==a)return void this._onError(p,"Flv: Unsupported audio codec idx: "+a);let n=0,r=(12&i)>>>2;if(!(r>=0&&r<=4))return void this._onError(g,"Flv: Invalid audio sample rate idx: "+r);n=this._flvSoundRateTable[r];let o=1&i,h=this._audioMetadata,d=this._audioTrack;if(h||(!1===this._hasAudio&&!1===this._hasAudioFlagOverrided&&(this._hasAudio=!0,this._mediaInfo.hasAudio=!0),h=this._audioMetadata={},h.type="audio",h.id=d.id,h.timescale=this._timescale,h.duration=this._duration,h.audioSampleRate=n,h.channelCount=0===o?1:2),10===a){let i=this._parseAACAudioData(e.slice(1));if(null==i)return;if(0===i.packetType){h.config&&t.w(this.TAG,"Found another AudioSpecificConfig!");let e=i.data;h.audioSampleRate=e.samplingRate,h.channelCount=e.channelCount,h.codec=e.codec,h.originalCodec=e.originalCodec,h.config=e.config,h.refSampleDuration=1024/h.audioSampleRate*h.timescale,t.v(this.TAG,"Parsed AudioSpecificConfig"),this._isInitialMetadataDispatched()?this._dispatch&&(this._audioTrack.length||this._videoTrack.length)&&this._onDataAvailable(this._audioTrack,this._videoTrack):this._audioInitialMetadataDispatched=!0,this._dispatch=!1,t.i(this.TAG,"ON!"),this._onTrackMetadata("audio",h);let s=this._mediaInfo;s.audioCodec=h.originalCodec,s.audioSampleRate=h.audioSampleRate,s.audioChannelCount=h.channelCount,s.hasVideo?null!=s.videoCodec&&(s.mimeType='video/x-flv; codecs="'+s.videoCodec+","+s.audioCodec+'"'):s.mimeType='video/x-flv; codecs="'+s.audioCodec+'"',s.isComplete()&&this._onMediaInfo(s)}else if(1===i.packetType){let e=this._timestampBase+s,t={unit:i.data,length:i.data.byteLength,dts:e,pts:e};d.samples.push(t),d.length+=i.data.length}else t.e(this.TAG,`Flv: Unsupported AAC data type ${i.packetType}`)}else if(2===a){if(!h.codec){let s=this._parseMP3AudioData(e.slice(1),!0);if(null==s)return;h.audioSampleRate=s.samplingRate,h.channelCount=s.channelCount,h.codec=s.codec,h.originalCodec=s.originalCodec,h.refSampleDuration=1152/h.audioSampleRate*h.timescale,t.v(this.TAG,"Parsed MPEG Audio Frame Header"),this._audioInitialMetadataDispatched=!0,this._onTrackMetadata("audio",h);let i=this._mediaInfo;i.audioCodec=h.codec,i.audioSampleRate=h.audioSampleRate,i.audioChannelCount=h.channelCount,i.audioDataRate=s.bitRate,i.hasVideo?null!=i.videoCodec&&(i.mimeType='video/x-flv; codecs="'+i.videoCodec+","+i.audioCodec+'"'):i.mimeType='video/x-flv; codecs="'+i.audioCodec+'"',i.isComplete()&&this._onMediaInfo(i)}let i=this._parseMP3AudioData(e.slice(1),!1);if(null==i)return;let a=this._timestampBase+s,n={unit:i,length:i.byteLength,dts:a,pts:a};d.samples.push(n),d.length+=i.length}}_parseAACAudioData(e){if(e.length<=1)return void t.w(this.TAG,"Flv: Invalid AAC packet, missing AACPacketType or/and Data!");let s={};return s.packetType=e[0],0===e[0]?s.data=this._parseAACAudioSpecificConfig(e.slice(1)):s.data=e.subarray(1),s}_parseAACAudioSpecificConfig(e){let t=null,s=0,i=0,a=0,n=null;if(s=i=e[0]>>>3,a=(7&e[0])<<1|e[1]>>>7,a<0||a>=this._mpegSamplingRates.length)return void this._onError(g,"Flv: AAC invalid sampling frequency index!");let r=this._mpegSamplingRates[a],o=(120&e[1])>>>3;if(o<0||o>=8)return void this._onError(g,"Flv: AAC invalid channel configuration");5===s&&(n=(7&e[1])<<1|e[2]>>>7,e[2]);let h=self.navigator.userAgent.toLowerCase();return-1!==h.indexOf("firefox")?a>=6?(s=5,t=new Array(4),n=a-3):(s=2,t=new Array(2),n=a):-1!==h.indexOf("android")?(s=2,t=new Array(2),n=a):(s=5,n=a,t=new Array(4),a>=6?n=a-3:1===o&&(s=2,t=new Array(2),n=a)),t[0]=s<<3,t[0]|=(15&a)>>>1,t[1]=(15&a)<<7,t[1]|=(15&o)<<3,5===s&&(t[1]|=(15&n)>>>1,t[2]=(1&n)<<7,t[2]|=8,t[3]=0),{config:t,samplingRate:r,channelCount:o,codec:"mp4a.40."+s,originalCodec:"mp4a.40."+i}}_parseMP3AudioData(e,s){if(e.length<4)return void t.w(this.TAG,"Flv: Invalid MP3 packet, header missing!");let i=null;if(s){if(255!==e[0])return;let t=e[1]>>>3&3,s=(6&e[1])>>1,a=(240&e[2])>>>4,n=(12&e[2])>>>2,r=3!=(e[3]>>>6&3)?2:1,o=0,h=0,d=34,l="mp3";switch(t){case 0:o=this._mpegAudioV25SampleRateTable[n];break;case 2:o=this._mpegAudioV20SampleRateTable[n];break;case 3:o=this._mpegAudioV10SampleRateTable[n]}switch(s){case 1:d=34,a<this._mpegAudioL3BitRateTable.length&&(h=this._mpegAudioL3BitRateTable[a]);break;case 2:d=33,a<this._mpegAudioL2BitRateTable.length&&(h=this._mpegAudioL2BitRateTable[a]);break;case 3:d=32,a<this._mpegAudioL1BitRateTable.length&&(h=this._mpegAudioL1BitRateTable[a])}i={bitRate:h,samplingRate:o,channelCount:r,codec:l,originalCodec:l}}else i=e;return i}_parseVideoData(e,s,i){if(e.length<=1)return void t.w(this.TAG,"Flv: Invalid video packet, missing VideoData payload!");if(!0===this._hasVideoFlagOverrided&&!1===this._hasVideo)return;let a=e[0],n=(240&a)>>>4,r=15&a;7===r?this._parseAVCVideoPacket(e.slice(1),s,i,n):this._onError(p,`Flv: Unsupported codec in video frame: ${r}`)}_parseAVCVideoPacket(e,s,i,a){if(e.length<4)return void t.w(this.TAG,"Flv: Invalid AVC packet, missing AVCPacketType or/and CompositionTime");let n=this._littleEndian,r=new DataView(e.buffer),o=r.getUint8(0),h=(16777215&r.getUint32(0,!n))<<8>>8;if(0===o)this._parseAVCDecoderConfigurationRecord(e.slice(4));else if(1===o)this._parseAVCVideoData(e.slice(4),s,i,a,h);else if(2!==o)return void this._onError(g,`Flv: Invalid video packet type ${o}`)}_parseAVCDecoderConfigurationRecord(e){if(e.length<7)return void t.w(this.TAG,"Flv: Invalid AVCDecoderConfigurationRecord, lack of data!");let s=this._videoMetadata,i=this._videoTrack,a=this._littleEndian,n=new DataView(e.buffer);s?void 0!==s.avcc&&t.w(this.TAG,"Found another AVCDecoderConfigurationRecord!"):(!1===this._hasVideo&&!1===this._hasVideoFlagOverrided&&(this._hasVideo=!0,this._mediaInfo.hasVideo=!0),s=this._videoMetadata={},s.type="video",s.id=i.id,s.timescale=this._timescale,s.duration=this._duration);let r=n.getUint8(0),o=n.getUint8(1);if(n.getUint8(2),n.getUint8(3),1!==r||0===o)return void this._onError(g,"Flv: Invalid AVCDecoderConfigurationRecord");if(this._naluLengthSize=1+(3&n.getUint8(4)),3!==this._naluLengthSize&&4!==this._naluLengthSize)return void this._onError(g,"Flv: Strange NaluLengthSizeMinusOne: "+(this._naluLengthSize-1));let h=31&n.getUint8(5);if(0===h)return void this._onError(g,"Flv: Invalid AVCDecoderConfigurationRecord: No SPS");h>1&&t.w(this.TAG,`Flv: Strange AVCDecoderConfigurationRecord: SPS Count = ${h}`);let d=6;for(let t=0;t<h;t++){let i=n.getUint16(d,!a);if(d+=2,0===i)continue;let r=new Uint8Array(e.slice(d,d+i));d+=i;let o=L.parseSPS(r);if(0!==t)continue;s.codecWidth=o.codec_size.width,s.codecHeight=o.codec_size.height,s.presentWidth=o.present_size.width,s.presentHeight=o.present_size.height,s.profile=o.profile_string,s.level=o.level_string,s.bitDepth=o.bit_depth,s.chromaFormat=o.chroma_format,s.sarRatio=o.sar_ratio,s.frameRate=o.frame_rate,!1!==o.frame_rate.fixed&&0!==o.frame_rate.fps_num&&0!==o.frame_rate.fps_den||(s.frameRate=this._referenceFrameRate);let h=s.frameRate.fps_den,l=s.frameRate.fps_num;s.refSampleDuration=s.timescale*(h/l);let c=r.subarray(1,4),u="avc1.";for(let e=0;e<3;e++){let t=c[e].toString(16);t.length<2&&(t="0"+t),u+=t}s.codec=u;let m=this._mediaInfo;m.width=s.codecWidth,m.height=s.codecHeight,m.fps=s.frameRate.fps,m.profile=s.profile,m.level=s.level,m.refFrames=o.ref_frames,m.chromaFormat=o.chroma_format_string,m.sarNum=s.sarRatio.width,m.sarDen=s.sarRatio.height,m.videoCodec=u,m.hasAudio?null!=m.audioCodec&&(m.mimeType='video/x-flv; codecs="'+m.videoCodec+","+m.audioCodec+'"'):m.mimeType='video/x-flv; codecs="'+m.videoCodec+'"',m.isComplete()&&this._onMediaInfo(m)}let l=n.getUint8(d);if(0!==l){l>1&&t.w(this.TAG,`Flv: Strange AVCDecoderConfigurationRecord: PPS Count = ${l}`),d++;for(let e=0;e<l;e++){let e=n.getUint16(d,!a);d+=2,0!==e&&(d+=e)}s.avcc=new Uint8Array(e.length),s.avcc.set(new Uint8Array(e),0),t.v(this.TAG,"Parsed AVCDecoderConfigurationRecord"),this._isInitialMetadataDispatched()?this._dispatch&&(this._audioTrack.length||this._videoTrack.length)&&this._onDataAvailable(this._audioTrack,this._videoTrack):this._videoInitialMetadataDispatched=!0,this._dispatch=!1,this._onTrackMetadata("video",s)}else this._onError(g,"Flv: Invalid AVCDecoderConfigurationRecord: No PPS")}_parseAVCVideoData(e,s,i,a,n){t.v(this.TAG,s,i,this._timestampBase);let r=this._littleEndian,o=new DataView(e.buffer),h=[],d=0,l=e.length,c=0;const u=this._naluLengthSize;let m=this._timestampBase+s,g=1===a;for(;c<l;){if(c+4>=l){t.w(this.TAG,`Malformed Nalu near timestamp ${m}, offset = ${c}, dataSize = ${l}`);break}let s=o.getUint32(c,!r);if(3===u&&(s>>>=8),s>l-u)return void t.w(this.TAG,`Malformed Nalus near timestamp ${m}, NaluSize > DataSize!`);let i=31&o.getUint8(c+u);5===i&&(g=!0);let a=new Uint8Array(e.slice(c,c+u+s)),n={type:i,data:a};h.push(n),d+=a.byteLength,c+=u+s}if(h.length){let e=this._videoTrack,t={units:h,length:d,isKeyframe:g,dts:m,cts:n,pts:m+n};g&&(t.fileposition=i),e.samples.push(t),e.length+=d}}},this.media_handler.onError=(e,s)=>{t.d(this.TAG,e,s),postMessage(["onError",e,s])},this.media_handler.onMediaInfo=e=>{t.d(this.TAG,e),postMessage(["onMediaInfo",e])},this.media_handler.onMetaDataArrived=e=>{postMessage(["onMetaDataArrived",e])},this.media_handler.onScriptDataArrived=e=>{postMessage(["onScriptDataArrived",e])},this.media_handler.onScriptDataArrived=e=>{postMessage(["onMetaDataArrived",e])},this.media_handler.onScriptDataArrived=e=>{postMessage(["onMetaDataArrived",e])}}parseChunk(e){t.d(this.TAG,"parseChunk: "+e.length),this.chunk_parser.parseChunk(e)}onMessage(e){switch(t.d(this.TAG," onMessage: "+e.getMessageType()+" StreamID:"+e.getMessageStreamID()),e.getMessageType()){case 1:case 2:case 3:case 5:case 6:this.netconnections[e.getMessageStreamID()].parseMessage(e);break;case 4:this._handleUserControlMessage(e);break;case 8:t.d(this.TAG,"AUDIOFRAME: ",e),this.media_handler.handleMediaMessage(e);break;case 9:t.d(this.TAG,"VIDEOFRAME: ",e),this.media_handler.handleMediaMessage(e);break;case 18:t.d(this.TAG,"DATAFRAME: ",e),this.media_handler.handleMediaMessage(e);break;case 19:t.d(this.TAG,"SharedObjectMessage",e);break;case 20:let s=(new N).parseAMF0(e.getPayload());switch(t.d(this.TAG,"AMF0",s),s[0]){case"_result":switch(this.trackedCommand){case"connect":t.d(this.TAG,"got _result: "+s[3].code),"NetConnection.Connect.Success"===s[3].code&&(postMessage([s[3].code]),this.createStream(null));break;case"createStream":t.d(this.TAG,"got _result: "+s[3]),s[3]&&postMessage(["RTMPStreamCreated"]);break;case"play":case"pause":break;default:t.w("tracked command:"+this.trackedCommand)}break;case"onStatus":t.d(this.TAG,"onStatus: "+s[3].code),postMessage([s[3].code]);break;default:t.w(this.TAG,"CommandMessage "+s[0]+" not yet implemented")}break;case 22:break;case 15:case 16:case 17:t.e(this.TAG,"AMF3 is not yet implemented");break;default:t.d(this.TAG,"[MessageType: "+_.MessageTypes[e.getMessageType()]+"("+e.getMessageType()+")")}}connect(e){const t=new N(["connect",1,e]);this._sendCommand(3,t)}createStream(e){const t=new N(["createStream",1,e]);this._sendCommand(3,t)}play(e){const t=new N(["play",1,null,e]);this._sendCommand(3,t)}pause(e){const t=new N(["pause",0,null,e,0]);this._sendCommand(3,t)}receiveVideo(e){const t=new N(["receiveVideo",0,null,e]);this._sendCommand(3,t)}receiveAudio(e){const t=new N(["receiveAudio",0,null,e]);this._sendCommand(3,t)}_sendCommand(e,s){t.d(this.TAG,"sendCommand:",s),this.trackedCommand=s.getCommand();let i=new _(s.getBytes());i.setMessageType(20),i.setMessageStreamID(0);const a=new f(i);a.setChunkStreamID(e);let n=a.getBytes();this.netconnections[0]=new class{TAG="NetConnection";WindowAcknowledgementSize;MessageStreamID;CHUNK_SIZE=128;BandWidth;socket;constructor(e,s){this.MessageStreamID=e,t.d(this.TAG,s),this.handler=s,this.socket=s.socket}parseMessage(e){let s=e.getPayload();switch(e.getMessageType()){case 1:this.CHUNK_SIZE=s[0]<<24|s[1]<<16|s[2]<<8|s[3],this.handler.setChunkSize(this.CHUNK_SIZE);break;case 2:case 3:case 5:this.WindowAcknowledgementSize=s[0]<<24|s[1]<<16|s[2]<<8|s[3],t.i(this.TAG,"WindowAcknowledgementSize: "+this.WindowAcknowledgementSize);break;case 6:this.BandWidth=s[0]<<24|s[1]<<16|s[2]<<8|s[3],t.i(this.TAG,"SetPeerBandwidth: "+this.BandWidth);let e=new S(5,this.WindowAcknowledgementSize),i=new _(e.getBytes());i.setMessageType(5);const a=new f(i);a.setChunkStreamID(2),t.i(this.TAG,"send WindowAcksize"),this.socket.send(a.getBytes())}}}(0,this),this.socket.send(n)}setChunkSize(e){this.chunk_parser.setChunkSize(e)}_getNextMessageStreamID(){return this.netconnections.length}_getNextChunkStreamID(){return++this.chunk_stream_id}_handleUserControlMessage(e){let s=e.getPayload();switch(this.event_type=s[0]<<8|s[1],s=s.slice(2),this.event_type){case 0:case 1:case 2:case 4:case 6:case 7:this.event_data1=s[0]<<24|s[1]<<16|s[2]<<8|s[3];break;case 3:this.event_data1=s[0]<<24|s[1]<<16|s[2]<<8|s[3],this.event_data2=s[4]<<24|s[5]<<16|s[6]<<8|s[7]}if(6===this.event_type){postMessage(["UserControlMessage",["ping",this.event_data1]]);const e=new y;e.setType(7),e.setEventData(this.event_data1);let s=new _(e.getBytes());s.setMessageType(4);const i=new f(s);i.setChunkStreamID(2),t.i(this.TAG,"send Pong"),this.socket.send(i.getBytes())}}}(K.getSocket()),t.d(z,"connect to RTMPManager"),K.registerMessageHandler((e=>{W.parseChunk(new Uint8Array(e.data))})),postMessage(["RTMPHandshakeDone"])):(t.e(z,"Handshake failed"),postMessage(["RTMPHandshakeFailed"]))},e.do()}else t.v(this.TAG,"WSSConnectFailed"),postMessage(["WSSConnectFailed"])}));break;case"connect":W.connect({app:a=i.appName,flashVer:"WebRTMP 0,0,1",tcUrl:"rtmp://"+j+":1935/"+a,fpad:!1,capabilities:15,audioCodecs:1024,videoCodecs:128,videoFunction:0});break;case"play":W.play(i.streamName);break;case"pause":W.pause(i.enable);break;case"disconnect":K.close();break;case"loglevels":t.d(z,"setting loglevels",i.loglevels),t.loglevels=i.loglevels;break;default:t.w(z,"Unknown CMD: "+i.cmd)}var a}),!1),postMessage(["Started"])})();
//# sourceMappingURL=webrtmp.worker.js.map